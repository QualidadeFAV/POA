<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovCirúrgica | Sistema de Governança</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
:root {
    /* Palette Profissional / Hospitalar */
    --primary: #0284c7;
    /* Sky 600 */
    --primary-dark: #0369a1;
    /* Sky 700 */
    --primary-light: #e0f2fe;
    /* Sky 100 */
    --secondary: #64748b;
    /* Slate 500 */

    /* Backgrounds */
    --bg-body: #e2e8f0;
    /* Slate 200 */
    --bg-surface: #ffffff;

    /* Textos */
    --text-main: #1e293b;
    /* Slate 800 */
    --text-secondary: #475569;
    /* Slate 600 */
    --text-light: #64748b;
    /* Slate 500 */

    --border: #cbd5e1;
    /* Slate 300 */
    --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --radius: 8px;

    /* Cores de KPI */
    --kpi-60: #7c3aed;
    /* Roxo */
    --kpi-40: #059669;
    /* Verde Esmeralda */

    /* Alertas */
    --alert-bg: #fff1f2;
    --alert-border: #fda4af;
    --alert-text: #be123c;
}

/* --- RESET & GLOBAL --- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
    -webkit-font-smoothing: antialiased;
}

body {
    background-color: var(--bg-body);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    font-size: 14px;
    overflow: hidden;
}

/* --- CUSTOM SCROLLBARS --- */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* --- LAYOUT GRID --- */
.app-container {
    display: grid;
    grid-template-columns: 360px 1fr;
    width: 100%;
    height: 100%;
}

/* --- COLUNA ESQUERDA (LISTAGEM) --- */
.listing-column {
    background: var(--bg-surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 10;
    box-shadow: 1px 0 10px rgba(0, 0, 0, 0.03);
    height: 100%;

    /* Transição suave para o efeito de trancar */
    transition: all 0.3s ease;
}

/* ESTADO TRANCADO (LOCKED) */
.listing-column.locked {
    pointer-events: none;
    /* Impede cliques */
    opacity: 0.4;
    /* Deixa transparente */
    filter: grayscale(100%);
    /* Tira a cor */
    user-select: none;
    /* Impede seleção de texto */
    background: #f1f5f9;
}

/* Header fixo da sidebar */
.listing-header {
    flex-shrink: 0;
    background: #fff;
    border-bottom: 1px solid var(--border);
    padding: 12px;
    /* Reduced from 16px */
    z-index: 20;
    display: flex;
    flex-direction: column;
    gap: 8px;
    /* Reduced from 12px */
}

/* Navegador de Data */
/* Navegador de Data Moderno */
.date-navigator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 8px 0;
}

.date-display-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: white;
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 20px;
    /* Pill shape */
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: all 0.2s ease;
    width: 150px;
    justify-content: center;
}

.date-display-box:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--primary);
    transform: translateY(-1px);
}

.modern-date-input {
    border: none;
    background: transparent;
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--text-main);
    width: 100%;
    text-align: center;
    outline: none;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
}

.icon-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    display: grid;
    place-items: center;
    border-radius: 50%;
    color: var(--text-secondary);
}

.icon-btn:hover {
    background: #e2e8f0;
    color: var(--primary);
}

/* Área de rolagem das vagas */
.date-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px 0 0 0;
    /* Added top padding */
    background: #f8fafc;
    position: relative;
}

/* Cabeçalho do Dia (Sticky) */
.date-header {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background-color: #f8fafc;
    z-index: 30;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
}

/* --- SLOT ITEM (CARD DE VAGA) --- */
.slot-item {
    background: white;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin: 0 16px 12px 16px;
    cursor: pointer;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.slot-item:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
    transform: translateY(-1px);
}

.slot-item.active {
    border-color: var(--primary);
    background: #f0f9ff;
    box-shadow: 0 0 0 1px var(--primary);
}

.slot-time {
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--text-main);
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 6px;
}

.slot-room-badge {
    background: #e0f2fe;
    color: #0369a1;
    font-weight: 700;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    text-transform: uppercase;
}

.slot-detail-box {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed var(--border);
}

.detail-patient {
    font-weight: 600;
    color: var(--text-main);
    font-size: 0.9rem;
}

.detail-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.badge-kpi {
    background: #f1f5f9;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.7rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    border: 1px solid #e2e8f0;
}

.slot-status-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 6px;
    background: #f1f5f9;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: inline-block;
    min-width: 40px;
    text-align: center;
}

.slot-status-badge.free {
    background: #ecfdf5;
    color: #059669;
}

.slot-status-badge.booked {
    background: #eff6ff;
    color: var(--primary-dark);
}

/* --- COLUNA DIREITA (PAINEL) --- */
.panel-column {
    background: var(--bg-body);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.top-bar {
    height: 72px;
    background: white;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    flex-shrink: 0;
}

.system-brand {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-box {
    width: 36px;
    height: 36px;
    background: var(--primary);
    border-radius: 8px;
    display: grid;
    place-items: center;
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
}

.brand-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text-main);
    letter-spacing: -0.01em;
}

.elegant-title {
    font-size: 1.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
}

.view-toggles {
    display: flex;
    background: #f1f5f9;
    padding: 4px;
    border-radius: 8px;
    gap: 4px;
}

.view-btn {
    padding: 8px 16px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 6px;
    border: none;
    background: transparent;
    transition: 0.2s;
}

.view-btn:hover {
    color: var(--text-main);
}

.view-btn.active {
    background: white;
    color: var(--text-main);
    box-shadow: var(--shadow-sm);
}

.dashboard-content {
    flex: 1;
    padding: 32px 40px;
    overflow-y: auto;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
}

/* --- STATS & KPI --- */
.global-stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.global-stat-card {
    flex: 1;
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideUpFade 0.5s ease backwards;
}

.global-stat-card:nth-child(1) {
    animation-delay: 0.05s;
}

.global-stat-card:nth-child(2) {
    animation-delay: 0.1s;
}

.global-stat-card:nth-child(3) {
    animation-delay: 0.15s;
}

.gs-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    font-size: 1.2rem;
}

.gs-info {
    text-align: right;
}

.gs-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 4px;
}

.gs-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text-main);
    line-height: 1;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 40px;
}

.kpi-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
}

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.kpi-label {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
}

.kpi-desc {
    font-size: 0.8rem;
    color: var(--text-light);
}

.kpi-value-big {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-main);
    line-height: 1;
}

.progress-bar-container {
    height: 8px;
    background: #f1f5f9;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 12px;
}

.progress-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
}

.kpi-subgrid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 24px;
}

.sub-stat {
    flex: 1 1 calc(30% - 12px);
    min-width: 90px;
    background: #f8fafc;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid var(--border);
    opacity: 0;
    animation: slideUpFade 0.5s ease forwards;
}

.sub-stat:nth-child(1) {
    animation-delay: 0.1s;
}

.sub-stat:nth-child(2) {
    animation-delay: 0.15s;
}

.sub-stat:nth-child(3) {
    animation-delay: 0.2s;
}

.sub-stat-label {
    font-size: 0.7rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
}

.sub-stat-val {
    font-size: 1.1rem;
    color: var(--text-main);
    font-weight: 700;
    margin-top: 4px;
}

/* --- MANAGERIAL VIEW --- */
.manager-section {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 32px;
}

.section-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.section-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-main);
}

.section-desc {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

.bulk-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 24px;
    align-items: end;
}

.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.data-table th {
    text-align: left;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
    font-weight: 600;
    background: #f8fafc;
    position: sticky;
    top: 0;
    z-index: 5;
}

.data-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text-main);
}

.data-table tr:hover {
    background: #f8fafc;
}

/* --- EMPTY STATE --- */
.empty-state-box {
    background: white;
    padding: 60px;
    border-radius: 16px;
    border: 1px dashed var(--border);
    text-align: center;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
}

.empty-icon {
    width: 64px;
    height: 64px;
    background: #f1f5f9;
    border-radius: 50%;
    display: grid;
    place-items: center;
    margin: 0 auto 24px auto;
    color: var(--text-light);
}

/* --- FORMS & INPUTS --- */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 8px;
}

.form-input,
.form-select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    color: var(--text-main);
    outline: none;
    transition: 0.2s;
    background: white;
}

.form-input:focus,
.form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1);
}

/* Novo: Input menor para procedimentos */
.proc-name-input {
    padding: 8px 12px;
    font-size: 0.9rem;
}

.filter-select {
    appearance: none;
    background-color: #f1f5f9;
    border: 1px solid transparent;
    border-radius: 6px;
    padding: 6px 24px 6px 10px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    transition: all 0.2s;
}

.filter-select:hover {
    background-color: #e2e8f0;
    color: var(--text-main);
}

.filter-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--primary-light);
}

/* --- PROCEDURE ROW (NOVO) --- */
.procedure-row {
    transition: all 0.2s;
}

.procedure-row:hover .btn-danger {
    background: #fee2e2;
    border-color: #fda4af;
    color: #be123c;
}

/* --- BUTTONS --- */
.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid transparent;
    transition: 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    box-shadow: 0 4px 6px -1px rgba(2, 132, 199, 0.2);
}

.btn-ghost {
    background: white;
    color: var(--text-secondary);
    border-color: var(--border);
}

.btn-ghost:hover {
    background: #f1f5f9;
    color: var(--text-main);
    border-color: #cbd5e1;
}

.btn-danger {
    background: #fff1f2;
    color: #be123c;
    border-color: #fda4af;
}

.btn-danger:hover {
    background: #ffe4e6;
}

.btn-success {
    background: #ecfdf5;
    color: #047857;
    border-color: #a7f3d0;
}

.btn-success:hover {
    background: #d1fae5;
}

/* --- MODALS (HIERARQUIA Z-INDEX) --- */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    /* Voltou para o centro! */
    justify-content: center;
}

.modal-overlay.open {
    display: flex;
    animation: fadeIn 0.2s;
}

/* HIERARQUIA DE CAMADAS FIXA */
#booking-modal {
    z-index: 2000 !important;
}

#message-modal {
    z-index: 3000 !important;
}

#login-modal {
    z-index: 9999 !important;
}

.modal-card {
    background: white;
    width: 550px;
    max-width: 95vw;
    max-height: 90vh;
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    padding: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    background: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-main);
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-light);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.close-btn:hover {
    background: #f1f5f9;
    color: var(--text-main);
}

.modal-body {
    padding: 24px;
    /* Retiramos o padding-bottom gigante */
    overflow-y: auto;
}

.modal-footer {
    padding: 24px;
    border-top: 1px solid var(--border);
    background: #f8fafc;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.alert-box {
    background: var(--alert-bg);
    border: 1px solid var(--alert-border);
    color: var(--alert-text);
    padding: 16px;
    border-radius: 8px;
    font-size: 0.9rem;
    margin-bottom: 24px;
    display: none;
    align-items: flex-start;
    gap: 12px;
}

.alert-icon {
    font-size: 1.2rem;
}

/* --- ANIMATIONS --- */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.98);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes slideUpFade {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.98);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes bounceIn {
    0% {
        transform: scale(0);
        opacity: 0;
    }

    60% {
        transform: scale(1.1);
        opacity: 1;
    }

    100% {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes shake {

    10%,
    90% {
        transform: translate3d(-1px, 0, 0);
    }

    20%,
    80% {
        transform: translate3d(2px, 0, 0);
    }

    30%,
    50%,
    70% {
        transform: translate3d(-4px, 0, 0);
    }

    40%,
    60% {
        transform: translate3d(4px, 0, 0);
    }
}

.view-section {
    animation: fadeInScale 0.3s ease-out;
}

/* --- FLATPICKR CUSTOMIZATION --- */
.flatpickr-day.has-free-slots {
    position: relative;
    font-weight: 700;
}

.flatpickr-day.has-free-slots::after {
    content: "";
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    background-color: #16a34a;
    /* Green 600 */
    border-radius: 50%;
}

.flatpickr-day.selected.has-free-slots::after {
    background-color: #fff;
}

/* --- TOOLTIPS CUSTOMIZADAS (HOVER NOS CARDS) --- */
.tooltip-container {
    position: relative;
}

.custom-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: #0284c7;
    /* Azul Sky 600 (Cor Primária do Dash) */
    color: #ffffff;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.75rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 10px 15px -3px rgba(2, 132, 199, 0.3);
    z-index: 100;
    pointer-events: none;
    width: 180px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* A setinha apontando para baixo */
.custom-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -6px;
    border-width: 6px;
    border-style: solid;
    border-color: #0284c7 transparent transparent transparent;
}

/* Ativa a animação ao passar o mouse */
.tooltip-container:hover .custom-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-8px);
}
</style>
</head>

<body>

    <div class="app-container">
        <aside class="listing-column">
            <div class="listing-header">
                <div class="listing-title" style="margin-bottom:12px; display:flex; flex-direction:column; gap:8px">
                    <div style="display:flex; justify-content:center; align-items:center; margin-bottom: 8px;">
                        <span style="font-weight:700; color:#1e293b; font-size:1.4rem;">Agenda</span>
                    </div>
                    <div style="display:flex; gap:8px">
                        <select id="location-filter" class="filter-select form-select" style="flex:1"
                            onchange="applyFilters()">
                            <option value="ALL">Todas Unidades</option>
                            <option value="Iputinga">Iputinga</option>
                            <option value="Boa Vista">Boa Vista</option>
                            <option value="Serra Talhada">Serra Talhada</option>
                            <option value="Salgueiro">Salgueiro</option>
                        </select>
                        <select id="room-filter" class="filter-select form-select" style="flex:1"
                            onchange="applyFilters()">
                            <option value="ALL">Todas Salas</option>
                        </select>
                    </div>
                    <div style="margin-top:8px; display:flex; gap:8px">
                        <select id="specialty-filter" class="filter-select form-select" style="flex:1"
                            onchange="applyFilters()">
                            <option value="ALL">Todas Especialidades</option>
                        </select>
                    </div>
                    <div style="margin-top:8px">
                        <select id="shift-filter" class="filter-select form-select" style="width:100%"
                            onchange="applyFilters()">
                            <option value="ALL">Todos os Turnos</option>
                            <option value="MANHA">Manhã</option>
                            <option value="TARDE">Tarde</option>
                        </select>
                    </div>
                </div>

                <div class="date-navigator">
                    <button class="view-btn icon-btn" onclick="changeDate(-1)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 18l-6-6 6-6" />
                        </svg>
                    </button>

                    <div class="date-display-box" id="date-trigger-box">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="color:var(--primary)">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <input type="text" id="sidebar-date-picker" class="modern-date-input" readonly
                            placeholder="Selecionar">
                    </div>

                    <button class="view-btn icon-btn" onclick="changeDate(1)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18l6-6-6-6" />
                        </svg>
                    </button>
                </div>

                <div style="margin-top:8px; display:flex; justify-content:center; gap:8px;">
                    <button class="view-btn" onclick="exportDailyReport()"
                        style="display:flex; align-items:center; gap:6px; font-size:0.8rem; background:#f0fdf4; color:#166534; border:1px solid #bbf7d0; flex:1; justify-content:center;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Exportar
                    </button>
                    <button id="btn-manual-refresh" class="view-btn" onclick="refreshData()"
                        style="display:flex; align-items:center; gap:6px; font-size:0.8rem; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; font-weight:600;"
                        title="Atualizar Agenda">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="date-list" id="slots-list-container">
            </div>
        </aside>

        <main class="panel-column">
            <header class="top-bar">
                <div class="system-brand">
                    <div class="logo-box">G</div>
                    <div class="brand-name elegant-title">Gerenciamento de Contratos</div>
                </div>

                <div class="view-toggles">
                    <button class="view-btn active" id="btn-view-booking" onclick="switchView('booking')">Mapa
                        Geral</button>
                    <button class="view-btn" id="btn-view-admin" onclick="switchView('admin')">Gestão de Vagas</button>
                </div>
            </header>

            <div class="dashboard-content" id="main-content">

                <div id="section-stats">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
                        <div style="font-size:0.9rem; font-weight:600; color:#64748b">Indicadores de Desempenho</div>

                        <div style="display:flex; gap:12px">
                            <button onclick="generateDashboardPDF()" class="btn btn-ghost"
                                style="padding: 6px 12px; font-size: 0.8rem; border:1px solid #cbd5e1; background:white; color:#475569"
                                title="Baixar PDF">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                PDF
                            </button>

                            <div
                                style="display:flex; align-items:center; gap:8px; background:white; padding:6px 12px; border-radius:8px; border:1px solid #cbd5e1; box-shadow:0 1px 2px rgba(0,0,0,0.05)">
                                <span style="font-size:0.8rem; font-weight:600; color:#1e293b">Período:</span>
                                <input type="date" id="dash-date-start"
                                    style="border:none; font-weight:600; color:#0284c7; outline:none; background:transparent; font-family:'Inter'"
                                    onchange="updateKPIs()">
                                <span>até</span>
                                <input type="date" id="dash-date-end"
                                    style="border:none; font-weight:600; color:#0284c7; outline:none; background:transparent; font-family:'Inter'"
                                    onchange="updateKPIs()">
                            </div>
                        </div>
                    </div>

                    <div class="global-stats-row">
                        <div class="global-stat-card">
                            <div class="gs-icon" style="background:#f1f5f9; color:#475569">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div class="gs-info">
                                <div class="gs-label">Total de Marcações</div>
                                <div class="gs-value" id="glb-marcacoes">0</div>
                            </div>
                        </div>

                        <div class="global-stat-card">
                            <div class="gs-icon" style="background:#ecfdf5; color:#059669">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                </svg>
                            </div>
                            <div class="gs-info">
                                <div class="gs-label">Total de Cirurgia</div>
                                <div class="gs-value" id="glb-cirurgia">0</div>
                            </div>
                        </div>

                        <div class="global-stat-card">
                            <div class="gs-icon" style="background:#eff6ff; color:#2563eb">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                </svg>
                            </div>
                            <div class="gs-info">
                                <div class="gs-label">Total de Laser</div>
                                <div class="gs-value" id="glb-laser">0</div>
                            </div>
                        </div>


                    </div>

                    <div class="kpi-grid" id="kpi-panel">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-label" style="color:#7c3aed">Governança • Meta 60%</div>
                                    <div class="kpi-desc">Procedimentos Regulados</div>
                                </div>
                                <div class="kpi-value-big" id="kpi-60-val">0.0%</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="prog-60" style="width: 0%; background: #7c3aed"></div>
                            </div>
                            <div class="kpi-subgrid">
                                <div class="sub-stat">
                                    <div class="sub-stat-label">ESTADO</div>
                                    <div class="sub-stat-val" id="stat-estado">0%</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">SERRA</div>
                                    <div class="sub-stat-val" id="stat-serra">0%</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">SALGUEIRO</div>
                                    <div class="sub-stat-val" id="stat-salgueiro">0%</div>
                                </div>
                            </div>
                        </div>

                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-label" style="color:#64748b">Municípios</div>
                                    <div class="kpi-desc">Procedimentos Realizados</div>
                                </div>
                                <div class="kpi-value-big" id="kpi-mun-val" style="font-size: 2rem;">--</div>
                            </div>
                            <div class="kpi-subgrid">
                                <div class="sub-stat">
                                    <div class="sub-stat-label">RECIFE</div>
                                    <div class="sub-stat-val" id="stat-recife">0%</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">JABOATÃO</div>
                                    <div class="sub-stat-val" id="stat-jaboatao">0%</div>
                                </div>
                            </div>
                        </div>


                        <div class="kpi-card">
                            <div class="kpi-header">
                                <div>
                                    <div class="kpi-label" style="color:#059669">Governança • Meta 40%</div>
                                    <div class="kpi-desc">Procedimentos Internos</div>
                                </div>
                                <div class="kpi-value-big" id="kpi-40-val">0.0%</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="prog-40" style="width: 0%; background: #059669"></div>
                            </div>
                            <div class="kpi-subgrid">
                                <div class="sub-stat">
                                    <div class="sub-stat-label">ESTADO (INT)</div>
                                    <div class="sub-stat-val" id="stat-int-estado">0%</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">SERRA (INT)</div>
                                    <div class="sub-stat-val" id="stat-int-serra">0%</div>
                                </div>
                                <div class="sub-stat">
                                    <div class="sub-stat-label">SALGUEIRO (INT)</div>
                                    <div class="sub-stat-val" id="stat-int-salgueiro">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-booking" class="view-section">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                        <div class="kpi-card" style="padding: 24px; min-height: 350px;">
                            <div class="section-title" style="margin-bottom: 16px;">Distribuição por Local Físico</div>
                            <div style="height: 220px; position: relative;">
                                <canvas id="chart-location"></canvas>
                            </div>
                        </div>
                        <div class="kpi-card" style="padding: 24px; min-height: 350px;">
                            <div class="section-title" style="margin-bottom: 16px;">Governança por Contrato</div>
                            <div style="height: 220px; position: relative;">
                                <canvas id="chart-specialty"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-admin" class="view-section" style="display:none">
                    <div class="manager-section">
                        <div class="section-header">
                            <div class="section-title">Gerador de Capacidade em Lote</div>
                            <div class="section-desc">Defina os parâmetros para criar blocos de agenda.</div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; margin-bottom:16px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Unidade / Local</label>
                                <select class="form-select" id="bulk-location">
                                    <option value="Iputinga">Iputinga</option>
                                    <option value="Boa Vista">Boa Vista</option>
                                    <option value="Serra Talhada">Serra Talhada</option>
                                    <option value="Salgueiro">Salgueiro</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Sala</label>
                                <input type="number" class="form-input" id="bulk-room" placeholder="Nº">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Grupo de Procedimento</label>
                                <select class="form-select" id="bulk-group">
                                    <option value="CIRURGIA">Cirurgia</option>
                                    <option value="LASER">Laser</option>
                                </select>
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Médico Responsável</label>
                                <input type="text" class="form-input" id="bulk-doctor" placeholder="Dr. Nome do Médico">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Data da Agenda</label>
                                <input type="date" class="form-input" id="bulk-date">
                            </div>
                        </div>

                        <div class="bulk-grid" style="align-items:end; border-top:1px solid #cbd5e1; padding-top:20px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Horário Inicial</label>
                                <input type="time" class="form-input" id="bulk-start-time" value="07:00">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Horário Final</label>
                                <input type="time" class="form-input" id="bulk-end-time" value="12:00">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label">Quantidade de Vagas</label>
                                <input type="number" class="form-input" id="bulk-qty" value="1" min="1" max="20">
                            </div>
                            <button class="btn btn-primary" onclick="bulkCreateSlots()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Criar Vagas
                            </button>
                        </div>
                    </div>

                    <div class="manager-section">
                        <div class="section-header"
                            style="justify-content: space-between; display: flex; align-items: center;">
                            <div>
                                <div class="section-title">Painel de Vagas Abertas</div>
                                <div class="section-desc">Controle total das vagas disponíveis.</div>
                            </div>
                            <button class="btn btn-danger" id="btn-delete-selected"
                                style="padding:6px 16px; font-size:0.85rem; display:none; background-color: #ef4444; color: white;"
                                onclick="deleteSelectedSlots()">
                                Excluir Selecionados (<span id="count-selected">0</span>)
                            </button>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width:40px"><input type="checkbox" id="check-all-slots"
                                                onchange="toggleAllSlots(this)" style="cursor: pointer;"></th>
                                        <th>Data</th>
                                        <th>Hora</th>
                                        <th>Sala</th>
                                        <th>Médico / Esp.</th>
                                        <th>Status</th>
                                        <th style="text-align:center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="booking-modal">
        <div class="modal-card">
            <div class="modal-header">
                <div>
                    <div class="modal-title">Realizar Agendamento</div>
                    <div style="font-size:0.85rem; color:#64748b; margin-top:4px" id="modal-slot-info">...</div>
                </div>
                <button class="close-btn" onclick="closeModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body" id="modal-form"
                style="display:flex; flex-direction:column; gap:20px; padding-top:16px">
                <input type="hidden" id="selected-slot-id">

                <div style="background:#f8fafc; padding:16px; border-radius:8px; border:1px solid #e2e8f0">
                    <div
                        style="font-size:0.75rem; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; gap:6px">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Identificação do Paciente
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:16px">
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Prontuário</label>
                            <input type="text" class="form-input" id="bk-record" placeholder="Nº">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" class="form-input" id="bk-patient" placeholder="Nome do paciente">
                        </div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">

                    <div style="background:#f8fafc; padding:16px; border-radius:8px; border:1px solid #e2e8f0;">
                        <div
                            style="font-size:0.75rem; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; gap:6px">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                            Dados Clínicos
                        </div>
                        <div class="form-group" style="margin-bottom:12px">
                            <label class="form-label">Grupo</label>
                            <input type="text" class="form-input" id="bk-specialty" readonly
                                style="background:#f1f5f9; color:#64748b; font-weight:600; cursor:not-allowed">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label class="form-label">Procedimento Realizado</label>
                            <select class="form-select" id="bk-procedure" onchange="checkWarning()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>

                    <div
                        style="background:#f8fafc; padding:16px; border-radius:8px; border:1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:space-between;">
                        <div>
                            <div
                                style="font-size:0.75rem; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; gap:6px">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                Governança
                            </div>
                            <div class="form-group" style="margin-bottom:12px">
                                <label class="form-label">Contrato</label>
                                <select class="form-select" id="bk-contract" onchange="handleContractChange()">
                                    <option value="">Selecione...</option>
                                    <option value="ESTADO">ESTADO</option>
                                    <option value="SERRA">SERRA</option>
                                    <option value="SALGUEIRO">SALGUEIRO</option>
                                    <hr>
                                    <option value="RECIFE">RECIFE (Município)</option>
                                    <option value="JABOATÃO">JABOATÃO (Município)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label
                                style="display:flex; align-items:center; justify-content:center; gap:8px; font-size:0.9rem; font-weight:600; cursor:pointer; background:white; padding:10px; border:1px solid #cbd5e1; border-radius:8px; transition:0.2s; user-select:none;"
                                title="Marcar se é Regulado">
                                <input type="checkbox" id="bk-proc-regulated" checked onchange="toggleRegulated()"
                                    style="width:16px; height:16px; cursor:pointer;">
                                Procedimento Regulado
                            </label>

                            <div id="bk-internal-type-container"
                                style="display:none; margin-top:10px; background:#f1f5f9; padding:10px 14px; border-radius:8px; border:1px dashed #94a3b8;">
                                <div
                                    style="font-size:0.75rem; font-weight:700; color:#64748b; margin-bottom:8px; text-transform:uppercase;">
                                    Motivo Interno *</div>
                                <div style="display:flex; gap:16px; justify-content: center;">
                                    <label
                                        style="display:flex; align-items:center; gap:4px; font-size:0.85rem; font-weight:600; color:#0f172a; cursor:pointer;">
                                        <input type="radio" name="bk-internal-type" value="Emergência"> Emergência
                                    </label>
                                    <label
                                        style="display:flex; align-items:center; gap:4px; font-size:0.85rem; font-weight:600; color:#0f172a; cursor:pointer;">
                                        <input type="radio" name="bk-internal-type" value="Projetos"> Projetos
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert-box" id="warning-box" style="margin-bottom:0">
                    <div class="alert-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                            </path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <div>
                        <div style="font-weight:700; margin-bottom:4px">Impacto na Governança</div>
                        <div id="warning-msg-text">Este agendamento excede a meta proporcional.</div>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top:8px; border-radius:0 0 8px 8px; padding: 16px 24px;">
                    <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
                    <div id="action-buttons-area" style="display:flex; gap:12px">
                        <button class="btn btn-primary" onclick="confirmBookingFromModal()">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="message-modal">
        <div class="modal-card" style="max-width: 400px; text-align: center; padding: 32px 24px;">
            <div style="width: 64px; height: 64px; border-radius: 50%; background: #e0f2fe; color: #0284c7; display: grid; place-items: center; margin: 0 auto 16px auto; font-size: 32px;"
                id="msg-icon"></div>
            <h3 class="modal-title" id="msg-title"
                style="justify-content: center; font-size: 1.25rem; margin-bottom: 8px;">Título</h3>
            <div style="color: #475569; margin-bottom: 24px; line-height: 1.5;" id="msg-body">Corpo da mensagem</div>
            <div style="display: flex; gap: 12px; justify-content: center;" id="msg-actions">
                <button class="btn btn-ghost" onclick="closeMessageModal()" id="msg-btn-cancel">Cancelar</button>
                <button class="btn btn-primary" id="msg-btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="login-modal">
        <div class="modal-card"
            style="max-width: 400px; text-align: center; padding: 40px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <div style="margin-bottom: 24px;">
                <div
                    style="width: 60px; height: 60px; background: #0284c7; color: white; border-radius: 12px; display: grid; place-items: center; font-size: 1.8rem; margin: 0 auto 16px auto; font-weight: 700; box-shadow: 0 0 20px rgba(2, 132, 199, 0.4);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </div>
                <h2 style="font-size: 1.5rem; color: #1e293b; font-weight: 700; margin-bottom: 8px;">Acesso Restrito
                </h2>
                <p style="color: #475569; font-size: 0.9rem;">Identifique-se com seu token de marcador.</p>
            </div>

            <div style="margin-bottom: 24px;">
                <input type="password" id="login-token" class="form-input" placeholder="Token de Acesso"
                    style="text-align: center; font-size: 1.2rem; letter-spacing: 4px; padding: 16px; font-weight: 700;"
                    onkeypress="handleLoginKey(event)">
                <div id="login-error"
                    style="color: #dc2626; font-size: 0.8rem; margin-top: 8px; display: none; font-weight: 600;">Token
                    inválido.</div>
            </div>

            <button class="btn btn-primary" onclick="attemptLogin()"
                style="width: 100%; padding: 14px; font-size: 1rem;">
                Acessar Sistema
            </button>
        </div>
    </div>

    <div id="app-splash-screen"
        style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:#ffffff; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: opacity 0.5s ease;">
        <div
            style="width: 50px; height: 50px; border: 4px solid #f3f4f6; border-top: 4px solid #0284c7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;">
        </div>
        <div style="font-family:'Inter', sans-serif; font-weight:600; color:#1e293b; font-size:1.1rem;">Carregando
            dados...</div>
        <style>
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </div>

    <script>
// --- CONFIGURAÇÃO DA API (GOOGLE SHEETS) ---
// IMPORTANTE: Verifique se esta URL é a da sua implantação mais recente
const API_URL = "https://script.google.com/macros/s/AKfycbx-xQcWMi4xZaw_DfeczO9uQJozBVVrUizZxE__XE-9Ny9Jsc8_-avB0Txx4UbSeQNx/exec";

// --- DADOS GLOBAIS ---
let appointments = {};

// --- CACHE DE PERFORMANCE ---
const DASH_CACHE = {};
// Estrutura: { "2026-02": { total: 100, occupied: 50, loaded: true, counts: {...} } }

// CONFIGURAÇÃO DA DATA INICIAL (HOJE)
const todayDate = new Date();
const yInit = todayDate.getFullYear();
const mInit = String(todayDate.getMonth() + 1).padStart(2, '0');
const dInit = String(todayDate.getDate()).padStart(2, '0');
let selectedDateKey = `${yInit}-${mInit}-${dInit}`;

let currentView = 'booking';
let currentSlotId = null;
let currentDateKey = null;

// FLATPICKR INSTANCE
let fpInstance = null;

// CHART INSTANCES
let chartLocInstance = null;
let chartSpecInstance = null;

// --- ESTADO ---
let isMoveMode = false;
let clipboardPatient = null;


// --- CONTROLE DE SESSÃO ---
let currentUserToken = null;
let currentUserRole = null;
let currentUserName = null;
let pendingAction = null;

// --- CONSTANTES DE CONTRATOS ---
const CONTRACTS = {
    LOCALS: ["ESTADO", "SERRA", "SALGUEIRO"],
    MUNICIPAL: ["RECIFE", "JABOATÃO"]
};

// --- CONFIGURAÇÃO DE PROCEDIMENTOS DINÂMICOS ---
let SPECIALTY_PROCEDURES = {
    "CIRURGIA": [],
    "LASER": []
};

// --- HELPER DE GET CENTRALIZADO ---
async function apiGet(params = {}) {
    if (!currentUserToken) {
        showToast("Sessão expirada. Faça login novamente.", "error");
        requestToken(null, "Sessão expirada");
        throw new Error("Token ausente no frontend");
    }

    const query = new URLSearchParams({
        ...params,
        token: currentUserToken
    });

    try {
        const response = await fetch(`${API_URL}?${query.toString()}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        return data;
    } catch (error) {
        console.error("Erro API GET:", error);
        throw error;
    }
}

// --- GUARD GLOBAL PARA AÇÕES ---
function requireAuth() {
    if (!currentUserToken) {
        requestToken(null, "Sessão expirada");
        throw new Error("Token ausente");
    }
}

// --- BUSCAR PROCEDIMENTOS ---
async function fetchProcedures() {
    try {
        const data = await apiGet({ type: 'procedures' });
        if (data) SPECIALTY_PROCEDURES = data;
    } catch (error) { console.error("Falha ao carregar procedimentos:", error); }
}

// --- INDICADOR DE CARREGAMENTO (CURSOR) ---
function setLoading(isLoading, isBlocking = false) {
    const body = document.body;
    if (isLoading && isBlocking) {
        body.style.cursor = 'wait';
    } else {
        body.style.cursor = 'default';
    }
}

// --- NOTIFICAÇÃO TOAST (CONFIRMAÇÃO VISUAL) ---
function showToast(message, type = 'success') {
    let toast = document.getElementById('app-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'app-toast';
        toast.style.cssText = `
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; font-size: 0.9rem;
            z-index: 5000; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none;
            display: flex; align-items: center; gap: 8px;
        `;
        document.body.appendChild(toast);
    }
    const bg = type === 'success' ? '#059669' : (type === 'error' ? '#dc2626' : '#1e293b');
    toast.style.background = bg;

    const icon = type === 'success'
        ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
        : '';

    toast.innerHTML = `${icon} ${message}`;
    toast.style.top = '20px';
    toast.style.opacity = '1';

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.top = '0px';
    }, 3000);
}

// --- FORMATADOR DE DATA BR ---
function formatDateBR(dateString) {
    if (!dateString) return '';
    const parts = dateString.split('-');
    if (parts.length !== 3) return dateString; // Fallback
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
}

// --- FUNÇÃO DE ANIMAÇÃO (NUMBERS GO UP) ---
function animateMetric(elementId, targetValue, isPercentage = false) {
    const element = document.getElementById(elementId);
    if (!element) return;

    let startValue = 0;
    const currentText = element.innerText;

    if (currentText !== '--' && currentText !== '--%') {
        startValue = parseFloat(currentText.replace('%', '').replace('(', '').replace(')', ''));
        if (isNaN(startValue)) startValue = 0;
    }

    if (Math.abs(startValue - targetValue) < 0.1) {
        element.innerText = isPercentage ? targetValue.toFixed(1) + '%' : Math.floor(targetValue);
        return;
    }

    const duration = 1000;
    const startTime = performance.now();

    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);

        const current = startValue + (targetValue - startValue) * ease;

        if (isPercentage) {
            element.innerText = current.toFixed(1) + '%';
        } else {
            element.innerText = Math.floor(current);
        }

        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            element.innerText = isPercentage ? targetValue.toFixed(1) + '%' : Math.floor(targetValue);
        }
    }

    requestAnimationFrame(update);
}

// --- FUNÇÃO AUXILIAR PARA SUB-ESTATÍSTICAS ---
function animateSubMetric(elementId, val, groupTotal) {
    const element = document.getElementById(elementId);
    if (!element) return;

    const pct = groupTotal > 0 ? (val / groupTotal) * 100 : 0;
    const finalText = `${pct.toFixed(1)}% (${val})`;

    element.innerText = finalText;
}

// --- NOVAS FUNÇÕES AUXILIARES DE PROCEDIMENTOS ---

// Helper para ler/escrever os procedimentos do slot (compatível com JSON novo e String antiga)
function getProceduresFromSlot(slot) {
    if (!slot.procedure) return [];

    try {
        const parsed = JSON.parse(slot.procedure);
        if (Array.isArray(parsed)) return parsed;
        return [{ name: slot.procedure, regulated: (slot.regulated === true || slot.regulated === "TRUE" || slot.regulated === "YES") }];
    } catch (e) {
        // Fallback: é uma string antiga
        return [{ name: slot.procedure, regulated: (slot.regulated === true || slot.regulated === "TRUE" || slot.regulated === "YES") }];
    }
}

// --- FUNÇÃO CENTRAL DE CONTROLE DE CONTRATO ---
function handleContractChange() {
    const contract = document.getElementById('bk-contract').value;
    const isMunicipal = CONTRACTS.MUNICIPAL.includes(contract);
    const cb = document.getElementById('bk-proc-regulated');
    const label = cb.parentElement;

    if (isMunicipal) {
        cb.checked = false;
        cb.disabled = true;
        label.style.opacity = '0.5';
        label.style.cursor = 'not-allowed';
        label.title = "Não aplicável para contratos municipais";
    } else {
        cb.disabled = false;
        label.style.opacity = '1';
        label.style.cursor = 'pointer';
        label.title = "Marcar se é Regulado";
    }

    toggleRegulated();
}

// --- FUNÇÃO PARA MOSTRAR/ESCONDER MOTIVOS INTERNOS ---
function toggleRegulated() {
    checkWarning(); // Mantém o alerta do gráfico funcionando
    const isReg = document.getElementById('bk-proc-regulated').checked;
    const contract = document.getElementById('bk-contract').value;
    const container = document.getElementById('bk-internal-type-container');

    // MUDANÇA: Tiramos a obrigatoriedade de ter um contrato já selecionado
    // Se NÃO for regulado e NÃO for municipal, mostra as opções imediatamente
    if (!isReg && !CONTRACTS.MUNICIPAL.includes(contract)) {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
        // Limpa a seleção
        document.querySelectorAll('input[name="bk-internal-type"]').forEach(r => r.checked = false);
    }
}


function recalculateMonthCache(monthKey) {
    if (!monthKey) return;

    let totalSlots = 0;
    let occupiedSlots = 0;

    let counts = {
        Regulado: { Total: 0, ESTADO: 0, SERRA: 0, SALGUEIRO: 0 },
        Interno: { Total: 0, ESTADO: 0, SERRA: 0, SALGUEIRO: 0 },
        InternoTypes: {
            ESTADO: { Emergencia: 0, Projetos: 0 },
            SERRA: { Emergencia: 0, Projetos: 0 },
            SALGUEIRO: { Emergencia: 0, Projetos: 0 }
        },
        Municipal: { Total: 0, RECIFE: 0, JABOATÃO: 0 }
    };

    Object.keys(appointments).forEach(dateKey => {
        if (dateKey.startsWith(monthKey)) {
            const daySlots = appointments[dateKey];
            totalSlots += daySlots.length;

            daySlots.forEach(s => {
                if (s.status === 'OCUPADO') {
                    occupiedSlots++;

                    const c = s.contract ? s.contract.toUpperCase() : null;
                    if (!c) return;

                    const procs = getProceduresFromSlot(s);

                    if (CONTRACTS.MUNICIPAL.includes(c)) {
                        const countToAdd = procs.length > 0 ? procs.length : 1;
                        counts.Municipal.Total += countToAdd;
                        if (counts.Municipal[c] !== undefined) counts.Municipal[c] += countToAdd;

                    } else if (CONTRACTS.LOCALS.includes(c)) {
                        if (procs.length > 0) {
                            procs.forEach(p => {
                                if (p.regulated) {
                                    counts.Regulado.Total++;
                                    if (counts.Regulado[c] !== undefined) counts.Regulado[c]++;
                                } else {
                                    counts.Interno.Total++;
                                    if (counts.Interno[c] !== undefined) counts.Interno[c]++;

                                    // NOVA CONTAGEM DE TIPO
                                    if (p.type === 'Emergência') counts.InternoTypes[c].Emergencia++;
                                    else if (p.type === 'Projetos') counts.InternoTypes[c].Projetos++;
                                    else counts.InternoTypes[c].Emergencia++; // Fallback pra antigos
                                }
                            });
                        } else {
                            // Fallback
                            let isReg = (s.regulated === true || s.regulated === "TRUE" || s.regulated === "YES");
                            if (isReg) {
                                counts.Regulado.Total++;
                                if (counts.Regulado[c] !== undefined) counts.Regulado[c]++;
                            } else {
                                counts.Interno.Total++;
                                if (counts.Interno[c] !== undefined) counts.Interno[c]++;

                                // NOVA CONTAGEM DE TIPO (Fallback legados)
                                counts.InternoTypes[c].Emergencia++;
                            }
                        }
                    }
                }
            });
        }
    });

    if (!DASH_CACHE[monthKey]) DASH_CACHE[monthKey] = {};

    DASH_CACHE[monthKey].total = totalSlots;
    DASH_CACHE[monthKey].occupied = occupiedSlots;
    DASH_CACHE[monthKey].counts = counts;

    // Atualiza marcadores visuais sempre que recalcular cache
    updateCalendarMarkers();
}

// --- COMUNICAÇÃO COM O BACKEND (GOOGLE SHEETS) ---

// 2. PROCESSAMENTO DE DADOS (RAW -> APP)
function processRawData(rows, forceDateKey = null) {
    if ((!rows || rows.length === 0) && forceDateKey) {
        if (!appointments[forceDateKey]) appointments[forceDateKey] = [];
        return;
    }

    rows.forEach(row => {
        const key = row.date;
        if (!key) return;

        if (!appointments[key]) appointments[key] = [];

        const exists = appointments[key].find(s => String(s.id) === String(row.id));

        if (!exists) {
            appointments[key].push({
                id: row.id,
                date: row.date,
                time: row.time,
                room: row.room,
                location: row.location,
                doctor: row.doctor,
                specialty: row.specialty,
                status: row.status,
                patient: row.patient,
                record: row.record,
                contract: row.contract,
                regulated: (row.regulated === true || row.regulated === "TRUE" || row.regulated === "YES"),
                procedure: row.procedure,
                detail: row.detail,
                eye: row.eye,
                createdBy: row.createdBy || row.created_by,
                updatedBy: row.updatedBy || (row.status === 'OCUPADO' ? (row.createdBy || row.created_by) : "") // Fallback para legado
            });
        } else {
            const idx = appointments[key].findIndex(s => String(s.id) === String(row.id));
            if (idx !== -1) {
                appointments[key][idx] = {
                    ...appointments[key][idx],
                    status: row.status,
                    patient: row.patient,
                    record: row.record,
                    contract: row.contract,
                    regulated: (row.regulated === true || row.regulated === "TRUE" || row.regulated === "YES"),
                    procedure: row.procedure,
                    detail: row.detail,
                    eye: row.eye,
                    createdBy: row.createdBy || row.created_by,
                    updatedBy: row.updatedBy || (row.status === 'OCUPADO' ? (row.createdBy || row.created_by) : "") // Fallback para legado
                };
            }
        }
    });

    if (forceDateKey) {
        recalculateMonthCache(forceDateKey.substring(0, 7));
    } else if (rows.length > 0) {
        recalculateMonthCache(rows[0].date.substring(0, 7));
    }
}

// 3. BUSCAR DADOS DE UM DIA ESPECÍFICO
async function fetchRemoteData(dateKey, isBackground = false) {
    if (!isBackground) setLoading(true);
    try {
        const data = await apiGet({ date: dateKey });
        if (data.length === 0) appointments[dateKey] = [];
        processRawData(data, dateKey);

        if (dateKey === selectedDateKey) {
            renderSlotsList();
            if (currentView === 'admin') renderAdminTable();
        }
        updateKPIs();
    } catch (error) {
        if (!isBackground) showToast('Erro de conexão ou token inválido.', 'error');
    } finally {
        if (!isBackground) setLoading(false);
    }
}

// 4. SINCRONIZAR MÊS INTEIRO
async function syncMonthData(baseDateKey) {
    if (!baseDateKey) return;
    const parts = baseDateKey.split('-');
    const monthKey = `${parts[0]}-${parts[1]}`;

    if (DASH_CACHE[monthKey] && DASH_CACHE[monthKey].loaded) return;

    setLoading(true);
    try {
        const preUpdateHash = JSON.stringify(appointments[selectedDateKey] || []);
        const data = await apiGet({ month: monthKey });

        Object.keys(appointments).forEach(k => { if (k.startsWith(monthKey)) delete appointments[k]; });
        processRawData(data);

        if (!DASH_CACHE[monthKey]) recalculateMonthCache(monthKey);
        DASH_CACHE[monthKey].loaded = true;

        if (selectedDateKey.startsWith(monthKey)) {
            const postUpdateHash = JSON.stringify(appointments[selectedDateKey] || []);
            if (preUpdateHash !== postUpdateHash) renderSlotsList();
            if (currentView === 'admin') renderAdminTable();
            updateKPIs();
        }
    } catch (e) {
        showToast("Erro ao sincronizar mês.", "error");
    } finally {
        setLoading(false);
    }
}

// 5. ENVIAR DADOS (POST)
async function sendUpdateToSheet(payload) {
    try {
        requireAuth();
        payload.token = currentUserToken;

        const params = new URLSearchParams();
        for (const key in payload) {
            if (typeof payload[key] === "object") params.append(key, JSON.stringify(payload[key]));
            else params.append(key, payload[key]);
        }

        const response = await fetch(API_URL, { method: "POST", body: params });
        return await response.json();
    } catch (error) {
        return { status: "error", message: error.message };
    }
}

// --- SISTEMA DE LOGIN ---
async function attemptLogin() {
    const input = document.getElementById('login-token');
    const val = input.value.trim();
    const err = document.getElementById('login-error');
    const btn = document.querySelector('#login-modal .btn-primary');

    if (!val) return;

    btn.innerText = "Verificando...";
    btn.disabled = true;

    try {
        // Agora o front pergunta para a API se esse token existe
        const response = await fetch(`${API_URL}?type=verify&token=${val}`);
        const data = await response.json();

        if (data.valid) {
            currentUserToken = val;
            currentUserRole = data.user.role;
            currentUserName = data.user.name;

            closeLoginModal();
            initDataFlow(); // Carrega a agenda após o login sucesso
        } else {
            throw new Error("Token inválido");
        }
    } catch (error) {
        err.style.display = 'block';
        input.style.borderColor = '#dc2626';
    } finally {
        btn.innerText = "Acessar Sistema";
        btn.disabled = false;
    }
}

function handleLoginKey(e) { if (e.key === 'Enter') attemptLogin(); }

function requestToken(callback, customTitle = null) {
    pendingAction = callback;
    const modal = document.getElementById('login-modal');
    const input = document.getElementById('login-token');
    modal.querySelector('h2').innerText = customTitle || "Acesso Restrito";
    input.value = '';
    document.getElementById('login-error').style.display = 'none';
    input.style.borderColor = '';
    input.style.color = '';
    modal.style.display = 'flex';
    input.focus();
}

function closeLoginModal() {
    document.getElementById('login-modal').style.display = 'none';
    document.getElementById('login-token').value = '';
}

// --- NAVEGAÇÃO ---

function switchView(view) {
    if (view === 'admin') {
        // Pede autorização para entrar no modo Gestor
        requestToken(() => executeSwitch('admin'), "Acesso Gestor");
    } else {
        // Retorna para Agendamento mantendo o token da sessão
        executeSwitch('booking');
    }
}

function executeSwitch(view) {
    if (view === 'admin' && currentUserRole !== 'GESTOR') {
        return showToast('Permissão insuficiente.', 'error');
    }

    currentView = view;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-view-${view}`).classList.add('active');

    document.getElementById('view-booking').style.display = 'none';
    document.getElementById('view-admin').style.display = 'none';
    document.getElementById('section-stats').style.display = 'none';

    const sidebar = document.querySelector('.listing-column');

    if (view === 'booking') {
        document.getElementById('view-booking').style.display = 'block';
        document.getElementById('section-stats').style.display = 'block';
        sidebar.classList.remove('locked');
        updateKPIs();
    } else {
        document.getElementById('view-admin').style.display = 'block';
        renderAdminTable();
        sidebar.classList.add('locked');
    }
}

// --- INICIALIZAÇÃO OTIMIZADA ---
async function initData() {
    const splash = document.getElementById('app-splash-screen');

    // Se não tem token logado, remove a tela de loading imediatamente e pede login
    if (!currentUserToken) {
        if (splash) splash.remove();
        requestToken(null, "Bem-vindo ao GovCirúrgica");
        return;
    }
    initDataFlow();
}

async function initDataFlow() {
    await fetchProcedures();

    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

    const formatYMD = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    };

    const dashStart = document.getElementById('dash-date-start');
    const dashEnd = document.getElementById('dash-date-end');
    if (dashStart) dashStart.value = formatYMD(firstDay);
    if (dashEnd) dashEnd.value = formatYMD(lastDay);

    fpInstance = flatpickr("#sidebar-date-picker", {
        locale: "pt", dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y",
        defaultDate: selectedDateKey, disableMobile: "true",
        onChange: function (selectedDates, dateStr, instance) {
            if (dateStr && dateStr !== selectedDateKey) {
                selectedDateKey = dateStr;
                updateSidebarDate();
            }
        },
        onMonthChange: function (selectedDates, dateStr, instance) {
            const year = instance.currentYear;
            const month = String(instance.currentMonth + 1).padStart(2, '0');
            syncMonthData(`${year}-${month}`);
        }
    });

    const dashPicker = document.getElementById('dashboard-month-picker');
    if (dashPicker) {
        dashPicker.value = selectedDateKey.substring(0, 7);
        dashPicker.addEventListener('change', (e) => { syncMonthData(e.target.value); });
    }

    await syncMonthData(selectedDateKey);

    const triggerBox = document.getElementById('date-trigger-box');
    if (triggerBox && fpInstance) {
        triggerBox.addEventListener('click', () => { fpInstance.open(); });
    }

    const splash = document.getElementById('app-splash-screen');
    if (splash) {
        splash.style.opacity = '0';
        setTimeout(() => { splash.remove(); }, 500);
    }

    updateFilterOptions();
    renderSlotsList();
    updateKPIs();
    updateCalendarMarkers();
}

// ATUALIZA MARCADORES DO CALENDÁRIO (BOLINHA VERDE)
function updateCalendarMarkers() {
    if (!fpInstance) return;

    // Identifica dias com vagas livres
    const freeDates = [];
    Object.keys(appointments).forEach(key => {
        const slots = appointments[key];
        const hasFree = slots.some(s => s.status === 'LIVRE');
        if (hasFree) freeDates.push(key);
    });

    // Remove a classe customizada de todos os dias (limpeza)
    const days = document.querySelectorAll('.flatpickr-day');
    days.forEach(day => day.classList.remove('has-free-slots'));

    // Adiciona a classe visual nos dias livres
    // Flatpickr não tem API direta fácil para "addClassToDate", mas podemos redesenhar ou usar config.
    // Uma forma eficiente é manipular via onDayCreate, mas para atualizar dinamicamente setamos o evento novamente.

    fpInstance.set('onDayCreate', function (dObj, dStr, fp, dayElem) {
        // Formata a data do elemento dia para YYYY-MM-DD
        const date = dayElem.dateObj;
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const key = `${y}-${m}-${d}`;

        if (freeDates.includes(key)) {
            dayElem.classList.add('has-free-slots');
        }
    });

    // Força redraw para aplicar o onDayCreate se já estiver aberto, ou prepara para próxima abertura
    // (Flatpickr redesenha dias ao navegar, mas set('onDayCreate') não redesenha o mês atual automaticamente se nao mudar algo)
    // Redraw hack:
    fpInstance.redraw();
}

function updateSidebarDate() {
    // Atualiza input se mudou externamente (setas)
    if (fpInstance && fpInstance.input.value !== selectedDateKey) {
        fpInstance.setDate(selectedDateKey, false); // false = não disparar onChange
    }



    document.getElementById('room-filter').value = 'ALL';
    document.getElementById('location-filter').value = 'ALL';

    const monthKey = selectedDateKey.substring(0, 7);

    if (DASH_CACHE[monthKey] && DASH_CACHE[monthKey].loaded) {
        updateFilterOptions(); // Garante filtros sincronizados ao trocar dia (cache) 
        renderSlotsList();
    } else {
        // Carregamento de navegação não precisa bloquear cursor totalmente, mas ok ser breve.
        // Se quiser bloquear: setLoading(true, true);
        // Se quiser suave: setLoading(true, false);
        setLoading(true, false);
        syncMonthData(selectedDateKey).then(() => {
            updateFilterOptions(); // Garante filtros sincronizados após sync
            renderSlotsList();
            setLoading(false);
        });
    }
}

// ATUALIZAÇÃO MANUAL (SEM POLLLING)
async function refreshData() {
    // 1. Guarda estado dos filtros (já estão no DOM, mas garantindo)
    // 2. Chama sync forçado (invalidate cache se quiser, mas syncMonthData ja faz fetch remoto)

    const btn = document.getElementById('btn-manual-refresh');
    if (btn) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'wait';
        // Opcional: Animar ícone
        const icon = btn.querySelector('svg');
        if (icon) icon.style.animation = 'spin 1s linear infinite';
    }

    try {
        // Invalida cache do mês atual para forçar novo fetch
        const monthKey = selectedDateKey.substring(0, 7);
        if (DASH_CACHE[monthKey]) DASH_CACHE[monthKey].loaded = false;

        setLoading(true, false);
        await syncMonthData(selectedDateKey); // Busca dados frescos

        // 3. Renderiza mantendo filtros
        updateFilterOptions(); // Recalcula opções disponíveis
        renderSlotsList();
        updateKPIs();
        updateCalendarMarkers();

        showToast("Agenda atualizada.", "success");
    } catch (error) {
        console.error("Erro ao atualizar:", error);
        showToast("Falha na atualização.", "error");
    } finally {
        setLoading(false);
        if (btn) {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            const icon = btn.querySelector('svg');
            if (icon) icon.style.animation = 'none';
        }
    }
}

// --- VERIFICAÇÃO DE DISPONIBILIDADE (ANTI-COLISÃO) ---
async function verifySlotAvailability(slotId, isBackground = false) {
    // Para ser robusto com 15 users, o ideal seria um endpoint específico 'checkSlot'.
    // Como estamos usando Sheets/GET geral, o melhor é forçar um refresh silencioso da data/mês 
    // se quisermos certeza absoluta, OU confiar no 'syncMonthData' se ele foi chamado recentemente.
    // Pela regra de negócio "Segurança no Clique", vamos fazer um fetch pontual dos dados atuais
    // para garantir que 'appointments' esteja fresco.

    // Invalida cache propositalmente
    const monthKey = selectedDateKey.substring(0, 7);
    if (DASH_CACHE[monthKey]) DASH_CACHE[monthKey].loaded = false;

    // Se background, cursor wait mas NÃO blocking (se quiser) ou loading suave do botão
    setLoading(true, !isBackground);
    await syncMonthData(selectedDateKey);
    setLoading(false);

    // Busca novamente o slot na memória atualizada
    let foundSlot = null;
    if (appointments[selectedDateKey]) {
        foundSlot = appointments[selectedDateKey].find(s => String(s.id) === String(slotId));
    }

    if (!foundSlot) return null; // Slot sumiu (excluido?)
    return foundSlot;
}

function changeDate(delta) {
    const current = new Date(selectedDateKey + 'T00:00:00');
    current.setDate(current.getDate() + delta);
    const y = current.getFullYear();
    const m = String(current.getMonth() + 1).padStart(2, '0');
    const d = String(current.getDate()).padStart(2, '0');

    const newKey = `${y}-${m}-${d}`;

    if (fpInstance) {
        fpInstance.setDate(newKey, true); // true = dispara onChange (chama updateSidebarDate)
    }
}

// --- UI LISTA DE VAGAS ---

function handleSlotClick(slot, key) {
    currentSlotId = slot.id;
    currentDateKey = key;
    renderSlotsList();

    if (currentView === 'booking') {
        // Se estiver em modo Move, verifica compatibilidade básica
        if (slot.status === 'LIVRE') {
            handleVerifyAndOpen(slot);
        } else {
            // Se ocupado, abre modal de edição
            openBookingModal(slot, key);
        }
    }
}

async function handleVerifyAndOpen(slot) {
    // 1. OTIMISTA: Abre o modal IMEDIATAMENTE
    openBookingModal(slot, selectedDateKey);

    // 2. VERIFICAÇÃO EM BACKGROUND
    const modalTitle = document.getElementById('msg-title');
    const originalTitle = modalTitle ? modalTitle.innerText : 'Agendar';
    if (modalTitle) modalTitle.innerText = 'Agendar (Verificando...)';

    const FRESH_SLOT = await verifySlotAvailability(slot.id, true); // Background = true

    if (modalTitle) modalTitle.innerText = originalTitle;

    // 3. SE CONFIRMAR CONFLITO, APENAS AVISE E ATUALIZE
    if (!FRESH_SLOT) {
        closeModal();
        showToast("Vaga não encontrada ou excluída.", "error");
        renderSlotsList();
        return;
    }

    if (FRESH_SLOT.status !== 'LIVRE') {
        closeModal();
        // SIMPLIFICADO: "Vaga ocupada" e update na tela. Sem botões extras.
        showToast("Conflito: Vaga acabou de ser ocupada.", "error");
        renderSlotsList();
        return;
    }

    // Se ainda está aberto, atualiza dados (caso algo sutil tenha mudado) e segue a vida
}

function updateFilterOptions() {
    const slots = appointments[selectedDateKey] || [];

    const rooms = [...new Set(slots.map(s => s.room))].filter(r => r).sort();
    const locations = [...new Set(slots.map(s => s.location || 'Iputinga'))].filter(l => l).sort();
    const specialties = [...new Set(slots.map(s => s.specialty))].filter(s => s).sort();

    const roomSelect = document.getElementById('room-filter');
    const locSelect = document.getElementById('location-filter');
    const specSelect = document.getElementById('specialty-filter');

    // Save current values to restore if possible
    const currentRoom = roomSelect.value;
    const currentLoc = locSelect.value;
    const currentSpec = specSelect ? specSelect.value : 'ALL';

    roomSelect.innerHTML = '<option value="ALL">Todas Salas</option>';
    rooms.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        roomSelect.appendChild(opt);
    });
    // Restore selection or default to ALL
    if (rooms.includes(currentRoom)) {
        roomSelect.value = currentRoom;
    } else {
        roomSelect.value = 'ALL';
    }

    locSelect.innerHTML = '<option value="ALL">Todas Unidades</option>';
    locations.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l;
        opt.textContent = l;
        locSelect.appendChild(opt);
    });
    // Restore selection or default to ALL
    if (locations.includes(currentLoc)) {
        locSelect.value = currentLoc;
    } else {
        locSelect.value = 'ALL';
    }

    if (specSelect) {
        specSelect.innerHTML = '<option value="ALL">Todas Especialidades</option>';
        specialties.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            specSelect.appendChild(opt);
        });
        if (specialties.includes(currentSpec)) {
            specSelect.value = currentSpec;
        } else {
            specSelect.value = 'ALL';
        }
    }
}

function applyFilters() { renderSlotsList(); }

function renderSlotsList() {
    // updateFilterOptions(); // REMOVIDO: Filtros devem ser atualizados apenas ao trocar dia/dados
    const container = document.getElementById('slots-list-container');
    container.innerHTML = '';

    const currentDateSlots = appointments[selectedDateKey] || [];

    // FILTRAGEM SEGURA (Estado Mantido)
    const locFilter = document.getElementById('location-filter').value;
    const roomFilter = document.getElementById('room-filter').value;
    const shiftFilter = document.getElementById('shift-filter').value;
    const specFilter = document.getElementById('specialty-filter') ? document.getElementById('specialty-filter').value : 'ALL';

    let slots = currentDateSlots.filter(s => {
        // Excluir tecnicamente os 'EXCLUIDO' se vierem do backend
        if (String(s.status).toUpperCase() === 'EXCLUIDO') return false;

        let pass = true;
        if (locFilter !== 'ALL' && s.location !== locFilter) pass = false;
        // CORREÇÃO: Comparar String com String para evitar erro de tipo
        if (roomFilter !== 'ALL' && String(s.room) !== String(roomFilter)) pass = false;

        if (shiftFilter !== 'ALL') {
            const h = parseInt(s.time.split(':')[0]);
            if (shiftFilter === 'MANHA' && h >= 13) pass = false;
            if (shiftFilter === 'TARDE' && h < 13) pass = false;
        }

        if (specFilter !== 'ALL' && s.specialty !== specFilter) pass = false;

        return pass;
    });

    slots.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        if (a.status !== b.status) return a.status === 'LIVRE' ? -1 : 1;
        return a.time.localeCompare(b.time);
    });

    if (slots.length === 0) {
        container.innerHTML = `
        <div style="padding:40px; text-align:center; color:#94a3b8;">
            <div style="font-size:3rem; margin-bottom:16px; opacity:0.3">📭</div>
            <div>Nenhuma vaga encontrada para os filtros.</div>
        </div>`;
        return;
    }

    slots.forEach((slot, index) => {
        const item = document.createElement('div');
        item.className = 'slot-item';
        if (currentSlotId === slot.id) item.classList.add('active');

        // REMOVIDO: animationDelay para evitar pisca-pisca
        // item.style.animationDelay = `${index * 0.05}s`;

        let statusClass = slot.status === 'LIVRE' ? 'free' : 'booked';
        let statusText = slot.status === 'LIVRE' ? 'Disponível' : 'Ocupado';
        let doctorName = slot.doctor ? `<b>${slot.doctor.split(' ')[0]} ${slot.doctor.split(' ')[1] || ''}</b>` : 'Sem Médico';

        const parts = slot.date.split('-');
        const formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`;

        let mainInfo = `
        <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
                <div class="slot-time" style="display:flex; gap:8px; align-items:center;">
                    <span style="background:#e2e8f0; color:#475569; padding:2px 6px; border-radius:4px; font-size:0.75rem; font-weight:600;">${formattedDate}</span>
                    <span>${slot.time}</span>
                </div>
                 <div class="slot-room-badge" style="white-space:nowrap;">Sala ${slot.room}</div>
            </div>
            <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:4px;">${slot.location || 'Iputinga'}</div>
            <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:2px;">${doctorName}</div>
            <div style="font-size:0.75rem; color:#64748b; font-weight:600; margin-top:2px; text-transform:uppercase;">${slot.specialty || '-'}</div>
        `;

        if (slot.status === 'OCUPADO') {
            const procs = getProceduresFromSlot(slot);
            let procDisplay = '-';
            if (procs.length === 1) {
                procDisplay = procs[0].name;
            } else if (procs.length > 1) {
                procDisplay = `${procs.length} Procedimentos`;
            } else {
                procDisplay = slot.specialty || '-';
            }

            mainInfo += `
            <div style="font-size:0.75rem; color:#0284c7; margin-top:2px; font-weight:600">${procDisplay}</div>
            <div class="slot-detail-box">
                <div class="detail-patient">${slot.patient}</div>
                <div style="font-size:0.75rem; color:var(--text-light)">Pront: ${slot.record || '?'}</div>
                <div class="detail-meta"><span class="badge-kpi">${slot.contract}</span></div>
            </div>
            <div style="font-size:0.65rem; color:#94a3b8; text-align:right; margin-top:4px; font-style:italic">
                 ${slot.updatedBy ? 'Agendado por: ' + slot.updatedBy : ''} 
            </div>
            `;
        } else {
            // Em estado LIVRE, já mostramos a especialidade acima, então remove a redundância se quiser,
            // mas o layout padrão pede algo ali ou deixa vazio.
            // mainInfo += `<div style="font-size:0.75rem; color:var(--text-light); margin-top:2px;">${slot.specialty || '-'}</div>`;
        }

        mainInfo += `</div>`;

        item.innerHTML = `
        ${mainInfo}
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px">
             <div class="slot-status-badge ${statusClass}">${statusText}</div>
             ${slot.detail ? `<div style="font-size:0.7rem; color:var(--text-secondary); margin-top:4px">${slot.detail}</div>` : ''}
        </div>`;

        item.onclick = () => handleSlotClick(slot, slot.date);
        container.appendChild(item);
    });
}

// --- GERAÇÃO EM LOTE ---

// --- GERAÇÃO EM LOTE ---
function bulkCreateSlots() {
    const dateVal = document.getElementById('bulk-date').value;
    const location = document.getElementById('bulk-location').value;
    const room = document.getElementById('bulk-room').value.trim();
    const group = document.getElementById('bulk-group').value;
    const doctor = document.getElementById('bulk-doctor').value.trim();
    const startTime = document.getElementById('bulk-start-time').value;
    const endTime = document.getElementById('bulk-end-time').value;
    const qty = parseInt(document.getElementById('bulk-qty').value);

    // CORREÇÃO: Exigindo a Sala e o Médico corretamente
    if (!dateVal || !startTime || !endTime || !doctor || !room || isNaN(qty) || qty < 1) {
        return showToast('Preencha todos os campos, incluindo a Sala.', 'error');
    }

    const [h1, m1] = startTime.split(':').map(Number);
    const [h2, m2] = endTime.split(':').map(Number);
    const startMins = h1 * 60 + m1;
    const endMins = h2 * 60 + m2;

    if (endMins <= startMins) {
        return showToast('Horário final inválido.', 'error');
    }

    const slotDuration = (endMins - startMins) / qty;
    let slotsToSend = [];

    for (let i = 0; i < qty; i++) {
        const currentSlotMins = Math.round(startMins + (i * slotDuration));
        const h = Math.floor(currentSlotMins / 60);
        const m = currentSlotMins % 60;
        const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

        slotsToSend.push({
            id: Date.now() + i,
            date: dateVal,
            time: timeStr,
            room: room,
            location: location,
            doctor: doctor,
            specialty: group,
            procedure: group
            // createdBy removido: o backend infere do token
        });
    }

    // --- UX: SPINNER NO BOTÃO ---
    const btn = document.querySelector('button[onclick="bulkCreateSlots()"]');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg> Criando...`;
    btn.disabled = true;
    btn.style.opacity = '0.7';

    const payload = {
        action: "create_bulk",
        data: slotsToSend
    };

    sendUpdateToSheet(payload).then(resp => {
        // Restaura o botão
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        btn.style.opacity = '1';

        if (resp && resp.status === 'success') {
            showToast(`${qty} vagas criadas!`, 'success');

            // --- UX: LIMPANDO TODOS OS CAMPOS ---
            document.getElementById('bulk-room').value = '';
            document.getElementById('bulk-doctor').value = '';
            document.getElementById('bulk-date').value = '';
            document.getElementById('bulk-qty').value = '1';
            document.getElementById('bulk-start-time').value = '07:00';
            document.getElementById('bulk-end-time').value = '12:00';

            processRawData(slotsToSend.map(s => ({ ...s, status: 'LIVRE' })));

            selectedDateKey = dateVal;
            document.getElementById('sidebar-date-picker').value = selectedDateKey;
            renderSlotsList();
            updateKPIs();
            executeSwitch('booking');
        } else {
            showToast('Erro ao processar criação.', 'error');
        }
    }).catch(err => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        btn.style.opacity = '1';
        showToast('Erro no servidor.', 'error');
    });
}

// --- ADMIN TABLE ---

function renderAdminTable() {
    const tbody = document.getElementById('admin-table-body');
    if (!tbody) return;

    const currentlyChecked = Array.from(document.querySelectorAll('.slot-checkbox:checked'))
        .map(cb => String(cb.value));

    tbody.innerHTML = '';

    const targetMonth = selectedDateKey.substring(0, 7);
    const slots = [];

    Object.keys(appointments).forEach(k => {
        if (k.startsWith(targetMonth)) slots.push(...appointments[k]);
    });

    slots.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
    });

    slots.forEach(slot => {
        const tr = document.createElement('tr');

        let statusHtml = slot.status === 'OCUPADO'
            ? `<span style="background:#fee2e2; color:#dc2626; padding:2px 8px; border-radius:12px; font-weight:600; font-size:0.75rem">OCUPADO</span>`
            : `<span style="background:#dcfce7; color:#16a34a; padding:2px 8px; border-radius:12px; font-weight:600; font-size:0.75rem">LIVRE</span>`;

        const dateFmt = `${slot.date.split('-')[2]}/${slot.date.split('-')[1]}`;
        const isChecked = currentlyChecked.includes(String(slot.id)) ? 'checked' : '';

        let specDisplay = slot.specialty;
        const procs = getProceduresFromSlot(slot);
        if (procs.length > 1) specDisplay = `${procs.length} Procs`;
        else if (procs.length === 1) specDisplay = procs[0].name;

        tr.innerHTML = `
            <td style="text-align:center">
                <input type="checkbox" class="slot-checkbox" value="${slot.id}" ${isChecked} onchange="updateDeleteButton()">
            </td>
            <td>${dateFmt}</td>
            <td>${slot.time}</td>
            <td>${slot.room}</td>
            <td>
                <div style="font-weight:600; font-size:0.85rem">${slot.doctor}</div>
                <div style="font-size:0.75rem; color:var(--text-light)">${specDisplay}</div>
            </td>
            <td>${statusHtml}</td>
            <td style="text-align:center">
                <button class="btn btn-danger btn-delete-single" style="padding:4px 8px; font-size:0.75rem" onclick="deleteSlot('${slot.id}')">Excluir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    updateDeleteButton();

    const masterCheck = document.getElementById('check-all-slots');
    if (masterCheck) {
        const total = document.querySelectorAll('.slot-checkbox').length;
        const checked = document.querySelectorAll('.slot-checkbox:checked').length;
        masterCheck.checked = (total > 0 && total === checked);
    }
}

function toggleAllSlots(source) {
    document.querySelectorAll('.slot-checkbox').forEach(cb => cb.checked = source.checked);
    updateDeleteButton();
}

function updateDeleteButton() {
    const total = document.querySelectorAll('.slot-checkbox:checked').length;
    const btn = document.getElementById('btn-delete-selected');
    const countSpan = document.getElementById('count-selected');
    const singleBtns = document.querySelectorAll('.btn-delete-single');

    singleBtns.forEach(b => {
        b.style.opacity = total > 0 ? '0.3' : '1';
        b.style.pointerEvents = total > 0 ? 'none' : 'auto';
    });

    if (btn) {
        if (total > 0) {
            btn.style.display = 'inline-flex';
            if (countSpan) countSpan.innerText = total;
        } else {
            btn.style.display = 'none';
        }
    }
}

async function deleteSelectedSlots() {
    const checkboxes = document.querySelectorAll('.slot-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    if (ids.length === 0) return;

    showMessageModal('Confirmação', `Deseja excluir ${ids.length} vagas selecionadas?`, 'confirm', () => {
        processBatchDelete(ids);
    });
}

async function processBatchDelete(ids) {
    showMessageModal('Processando', `Excluindo ${ids.length} vagas...`, 'loading');

    // STRICT TOKEN: Se não tiver token, tenta login ou usa "Anonymous" (mas o backend precisa saber)
    // Assumindo que já está logado pois é Admin Area

    try {
        const payload = {
            action: "delete_bulk",
            ids: ids
        };

        // Usa sendUpdateToSheet para garantir mesmo formato (URLSearchParams)
        const resp = await sendUpdateToSheet(payload);

        if (resp && resp.status === 'success') {
            // Atualiza estado local em massa
            Object.keys(appointments).forEach(key => {
                appointments[key] = appointments[key].filter(s => !ids.includes(String(s.id)));
            });

            recalculateMonthCache(selectedDateKey.substring(0, 7));
            closeMessageModal();
            renderSlotsList();
            renderAdminTable();
            updateKPIs();

            showToast(`${resp.count || ids.length} vagas excluídas com sucesso.`, 'success');
        } else {
            closeMessageModal();
            showToast(`Erro ao excluir: ${resp ? resp.message : 'Resposta inválida'}`, 'error');
        }

    } catch (e) {
        closeMessageModal();
        console.error("Erro delete bulk:", e);
        showToast("Erro de conexão ao excluir.", "error");
    }
}

function deleteSlot(id) {
    const monthKey = selectedDateKey.substring(0, 7);
    let slot = null;

    Object.keys(appointments).forEach(k => {
        if (!slot && k.startsWith(monthKey)) slot = appointments[k].find(s => String(s.id) === String(id));
    });

    let msg = 'Excluir vaga permanentemente?';
    if (slot && slot.status === 'OCUPADO') {
        msg = `<b>ATENÇÃO:</b> Vaga com paciente <b>${slot.patient}</b>. Excluir removerá ambos.`;
    }

    showMessageModal('Excluir', msg, 'confirm', async () => {
        closeMessageModal();
        setLoading(true, true); // Bloqueante pois é uma ação destrutiva

        const resp = await sendUpdateToSheet({
            action: "delete",
            id: id
        });
        if (resp && resp.status === 'success') {
            Object.keys(appointments).forEach(key => {
                appointments[key] = appointments[key].filter(s => String(s.id) !== String(id));
            });

            recalculateMonthCache(selectedDateKey.substring(0, 7));
            renderSlotsList();
            renderAdminTable();
            updateKPIs();

            showToast('Vaga excluída.', 'success');
        }

        setLoading(false);
    });
}

// --- MODAL DE AGENDAMENTO E EDIÇÃO ---
function openBookingModal(slot, dateKey) {
    document.getElementById('booking-modal').classList.add('open');
    document.getElementById('msg-title').innerText = 'Agendar';

    // Preenche info do cabeçalho
    // Preenche info do cabeçalho
    document.getElementById('modal-slot-info').innerHTML = `
        <div style="display:flex; gap:12px; font-size: 0.9rem; align-items:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            <span>DATA: <b>${formatDateBR(dateKey)}</b></span>
            <span style="color:#cbd5e1">|</span>
            <span>HORA: <b>${slot.time}</b></span>
            <span style="color:#cbd5e1">|</span>
            <span style="overflow:hidden; text-overflow:ellipsis;">SALA: <b>${slot.room}</b></span>
        </div>
    `;

    document.getElementById('selected-slot-id').value = slot.id;
    document.getElementById('bk-specialty').value = slot.specialty || '';


    const btnArea = document.getElementById('action-buttons-area');
    btnArea.innerHTML = ''; // Limpa botões

    // --- MODO: VAGA OCUPADA (EDIÇÃO/REALOCAÇÃO) ---
    if (slot.status === 'OCUPADO') {
        document.getElementById('bk-patient').value = slot.patient || '';
        document.getElementById('bk-record').value = slot.record || '';
        document.getElementById('bk-contract').value = slot.contract || '';
        try {
            if (slot.procedure) {
                const plist = JSON.parse(slot.procedure);
                if (Array.isArray(plist) && plist.length > 0) {
                    updateProcedureSelectOptions(slot.specialty, plist[0].name || '');
                    document.getElementById('bk-proc-regulated').checked = plist[0].regulated;

                    // NOVA CARGA
                    if (!plist[0].regulated && plist[0].type) {
                        document.querySelectorAll('input[name="bk-internal-type"]').forEach(r => {
                            if (r.value === plist[0].type) r.checked = true;
                        });
                    }
                }
            }
        } catch (e) {
            updateProcedureSelectOptions(slot.specialty, slot.procedure || '');
            document.getElementById('bk-proc-regulated').checked = slot.regulated || false;
        }
        toggleRegulated(); // Força a tela a se arrumar

        // Botão de Cancelar/Liberar (REMOVIDO BOTÃO DE REALOCAR)
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-danger';
        cancelBtn.innerText = 'Liberar Vaga';
        cancelBtn.onclick = cancelSlotBooking;
        btnArea.appendChild(cancelBtn);

        // Botão Salvar Edição
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-primary';
        saveBtn.innerText = 'Salvar Alterações';
        saveBtn.onclick = confirmBookingFromModal;
        btnArea.appendChild(saveBtn);

        // --- MODO: VAGA LIVRE (DESTINO DE REALOCAÇÃO OU NOVO) ---
    } else {
        // Limpa campos para novo agendamento
        document.getElementById('bk-patient').value = '';
        document.getElementById('bk-record').value = '';
        document.getElementById('bk-contract').value = '';

        updateProcedureSelectOptions(slot.specialty, '');
        document.getElementById('bk-proc-regulated').checked = true;

        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'btn btn-primary';
        confirmBtn.innerText = 'Confirmar';
        confirmBtn.onclick = confirmBookingFromModal;
        btnArea.appendChild(confirmBtn);

        // ADICIONE ESTA LINHA AQUI:
        toggleRegulated();
    }
}

function updateProcedureSelectOptions(specialtyGroup, currentProcName = '') {
    const select = document.getElementById('bk-procedure');
    select.innerHTML = '<option value="">Selecione o procedimento...</option>';

    // Normaliza a especialidade 
    const rawSpecialty = (specialtyGroup || "").trim();
    const mapAccents = { 'Ç': 'C', 'Ã': 'A', 'Õ': 'O', 'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U', 'Â': 'A', 'Ê': 'E', 'À': 'A' };
    let normalizedSpec = rawSpecialty.toUpperCase().replace(/[ÇÃÕÁÉÍÓÚÂÊ]/g, c => mapAccents[c] || c);

    if (normalizedSpec === 'LASERS') normalizedSpec = 'LASER';

    // Fallback: Se não for LASER, usamos CIRURGIA por padrão para as demais
    if (normalizedSpec !== 'LASER') {
        normalizedSpec = 'CIRURGIA';
    }

    // Pega a lista original e CRIA UMA CÓPIA ORDENADA ALFABETICAMENTE
    let procs = SPECIALTY_PROCEDURES[normalizedSpec] || [];
    procs = [...procs].sort((a, b) => a.localeCompare(b, 'pt-BR'));

    // Adiciona ao <select>
    procs.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        if (p === currentProcName) opt.selected = true;
        select.appendChild(opt);
    });

    if (currentProcName && !procs.includes(currentProcName)) {
        const opt = document.createElement('option');
        opt.value = currentProcName;
        opt.textContent = currentProcName + " (Legado/Personalizado)";
        opt.selected = true;
        select.appendChild(opt);
    }
}

function closeModal() { document.getElementById('booking-modal').classList.remove('open'); }

function checkWarning() {
    const contract = document.getElementById('bk-contract').value;
    const warningBox = document.getElementById('warning-box');
    const msgText = document.getElementById('warning-msg-text');

    if (!contract || CONTRACTS.MUNICIPAL.includes(contract)) {
        warningBox.style.display = 'none';
        return;
    }

    let newReg = 0;
    let newInt = 0;
    const nameInput = document.getElementById('bk-procedure');
    if (nameInput && nameInput.value.trim()) {
        const isReg = document.getElementById('bk-proc-regulated').checked;
        if (isReg) newReg = 1; else newInt = 1;
    }

    if (newReg === 0 && newInt === 0) newReg = 1;

    const monthKey = selectedDateKey.substring(0, 7);
    const stats = DASH_CACHE[monthKey];

    if (!stats || stats.total === 0) return;

    let currentTotalReg = stats.counts.Regulado.Total;
    let currentTotalInt = stats.counts.Interno.Total;

    let simTotalReg = currentTotalReg + newReg;
    let simTotalInt = currentTotalInt + newInt;
    let simTotal = simTotalReg + simTotalInt;

    if (simTotal === 0) simTotal = 1;

    const pctReg = (simTotalReg / simTotal) * 100;
    const pctInt = (simTotalInt / simTotal) * 100;

    let showWarning = false;
    let msg = "";

    if (newInt > 0 && pctInt > 40) {
        showWarning = true;
        msg = `Atenção: Procedimentos Internos atingirão <b>${pctInt.toFixed(1)}%</b> (Limite: 40%)`;
    } else if (newInt > 0 && pctReg < 60) {
        showWarning = true;
        msg = `Atenção: Regulados cairão para <b>${pctReg.toFixed(1)}%</b> (Meta: >60%)`;
    }

    if (showWarning) {
        warningBox.style.display = 'flex';
        if (msgText) msgText.innerHTML = msg;
        else {
            const div = document.createElement('div');
            div.id = 'warning-msg-text';
            div.innerHTML = msg;
            warningBox.appendChild(div);
        }
    } else {
        warningBox.style.display = 'none';
    }
}

function confirmBookingFromModal() {
    const id = document.getElementById('selected-slot-id').value;
    const record = document.getElementById('bk-record').value;
    const patient = document.getElementById('bk-patient').value;
    const contract = document.getElementById('bk-contract').value;
    const name = document.getElementById('bk-procedure').value.trim();
    const isReg = document.getElementById('bk-proc-regulated').checked;

    if (!patient || !contract || !record || !name) {
        return showToast('Preencha os campos obrigatórios e o procedimento.', 'error');
    }

    let internalType = null;

    if (!isReg && !CONTRACTS.MUNICIPAL.includes(contract)) {
        const selectedRadio = document.querySelector('input[name="bk-internal-type"]:checked');
        if (!selectedRadio) {
            return showToast('Obrigatório selecionar Emergência ou Projetos.', 'error');
        }
        internalType = selectedRadio.value;
    }

    const procedureJSON = JSON.stringify([{ name: name, regulated: isReg, type: internalType }]);
    const mainRegulatedStatus = isReg;

    const summary = `
        <div style="text-align:left; background:#f8fafc; padding:16px; border-radius:8px; font-size:0.9rem; border:1px solid #e2e8f0">
            <div><b>Paciente:</b> ${patient}</div>
            <div><b>Contrato:</b> ${contract}</div>
            <div style="margin-top:8px; font-weight:600; border-top:1px dashed #ccc; padding-top:4px">Procedimento:</div>
            <ul style="margin:0; padding-left:20px; font-size:0.85rem">
                <li>${name} (${isReg ? 'Regulado' : 'Interno'})</li>
            </ul>
        </div>
        <div style="margin-top:16px; font-weight:600">Confirmar?</div>
    `;

    showMessageModal('Confirmação', summary, 'confirm', () => {
        requestToken(async () => {
            Object.keys(appointments).forEach(dateKey => {
                const slotIndex = appointments[dateKey].findIndex(s => String(s.id) === String(id));
                if (slotIndex !== -1) {
                    appointments[dateKey][slotIndex] = {
                        ...appointments[dateKey][slotIndex],
                        status: 'OCUPADO',
                        patient: patient,
                        record: record,
                        contract: contract,
                        regulated: mainRegulatedStatus,
                        procedure: procedureJSON,
                        detail: "",
                        eye: ""
                        // createdBy removido: o backend infere do token
                    };
                }
            });

            recalculateMonthCache(selectedDateKey.substring(0, 7));
            closeMessageModal();
            closeModal();
            renderSlotsList();
            updateKPIs();
            showToast("Agendamento realizado!", "success");

            const payload = {
                action: "update",
                id: id,
                status: 'OCUPADO',
                patient: patient,
                record: record,
                contract: contract,
                regulated: mainRegulatedStatus,
                procedure: procedureJSON,
                detail: "",
                eye: ""
            };

            sendUpdateToSheet(payload).then(async (resp) => {
                const success = resp && resp.status === 'success';
                if (!success) {
                    showToast("CONFLITO: Vaga já ocupada ou erro de servidor.", "error");
                    await refreshData(); // Auto refresh em conflito
                } else {
                    // SE SUCESSO E ESTAMOS EM MODO MOVE, LIBERA A ORIGEM
                    if (isMoveMode && clipboardPatient && clipboardPatient.originId) {
                        const originId = clipboardPatient.originId;
                        // Envia liberação da antiga
                        await sendUpdateToSheet({
                            action: "update",
                            id: originId,
                            status: 'LIVRE',
                            patient: '', record: '', contract: '', regulated: null,
                            procedure: '', detail: '', eye: ''
                        });

                        // Limpa estado local da origem
                        Object.keys(appointments).forEach(k => {
                            const idx = appointments[k].findIndex(s => String(s.id) === String(originId));
                            if (idx !== -1) {
                                appointments[k][idx].status = 'LIVRE';
                                appointments[k][idx].patient = '';
                                // ... limpar resto se quiser visualmente perfeito,
                                // mas o refresh ou render ja resolve
                            }
                        });

                        showToast("Realocação concluída com sucesso!", "success");

                        // Reset flags
                        isMoveMode = false;
                        clipboardPatient = null;
                        document.querySelector('.listing-column').style.borderLeft = "none";

                        // Refresh final para garantir consistencia visual
                        renderSlotsList();
                    }
                }
            });
        });
    });
}

function cancelSlotBooking() {
    showMessageModal('Liberar Vaga', 'Remover paciente e procedimentos?', 'confirm', () => {
        requestToken(async () => {
            const id = document.getElementById('selected-slot-id').value;

            Object.keys(appointments).forEach(dateKey => {
                const slotIndex = appointments[dateKey].findIndex(s => String(s.id) === String(id));
                if (slotIndex !== -1) {
                    appointments[dateKey][slotIndex] = {
                        ...appointments[dateKey][slotIndex],
                        status: 'LIVRE',
                        patient: '', record: '', contract: '', regulated: null,
                        procedure: '', detail: '', eye: ''
                    };
                }
            });

            recalculateMonthCache(selectedDateKey.substring(0, 7));
            closeMessageModal();
            closeModal();
            renderSlotsList();
            updateKPIs();
            showToast("Vaga liberada.", "success");

            const payload = {
                action: "update",
                id: id,
                status: 'LIVRE',
                patient: '', record: '', contract: '', regulated: null,
                procedure: '', detail: '', eye: ''
            };

            sendUpdateToSheet(payload);
        }, "Autorizar Cancelamento");
    });
}

// --- KPI: AJUSTADA PARA CONTAR PROCEDIMENTOS ---
function calculateFilteredStats() {
    const startInput = document.getElementById('dash-date-start');
    const endInput = document.getElementById('dash-date-end');

    let startDate = startInput && startInput.value ? startInput.value : selectedDateKey;
    let endDate = endInput && endInput.value ? endInput.value : startDate;

    if (startDate > endDate && endDate) endDate = startDate;

    let totalSlots = 0;
    let occupiedSlots = 0;
    let totalMarcacoes = 0;
    let totalCirurgia = 0;
    let totalLaser = 0;

    let counts = {
        Regulado: { Total: 0, ESTADO: 0, SERRA: 0, SALGUEIRO: 0 },
        Interno: { Total: 0, ESTADO: 0, SERRA: 0, SALGUEIRO: 0 },
        InternoTypes: {
            ESTADO: { Emergencia: 0, Projetos: 0 },
            SERRA: { Emergencia: 0, Projetos: 0 },
            SALGUEIRO: { Emergencia: 0, Projetos: 0 }
        },
        Municipal: { Total: 0, RECIFE: 0, JABOATÃO: 0 }
    };

    let locationCounts = {};

    Object.keys(appointments).forEach(dateKey => {
        if (dateKey >= startDate && dateKey <= endDate) {
            const daySlots = appointments[dateKey];
            totalSlots += daySlots.length;
            daySlots.forEach(s => {
                if (s.status === 'OCUPADO') {
                    occupiedSlots++;
                    totalMarcacoes++;

                    let isLaser = false;
                    let isCirurgia = false;

                    if (s.specialty && s.specialty.toUpperCase() === 'LASER') {
                        isLaser = true;
                    } else if (s.specialty && s.specialty.toUpperCase().includes('LASER')) {
                        isLaser = true; // Fallback para legados
                    } else {
                        isCirurgia = true;
                    }

                    if (isLaser) totalLaser++;
                    if (isCirurgia) totalCirurgia++;

                    const procs = getProceduresFromSlot(s);
                    const procsLen = procs.length > 0 ? procs.length : 1;

                    // Conta por local físico
                    const loc = s.location ? s.location.trim() : "Outros";
                    if (!locationCounts[loc]) locationCounts[loc] = 0;
                    locationCounts[loc] += procsLen;

                    const c = s.contract ? s.contract.toUpperCase() : null;
                    if (!c) return;

                    if (CONTRACTS.MUNICIPAL.includes(c)) {
                        const countToAdd = procs.length > 0 ? procs.length : 1;
                        counts.Municipal.Total += countToAdd;
                        if (counts.Municipal[c] !== undefined) counts.Municipal[c] += countToAdd;

                    } else if (CONTRACTS.LOCALS.includes(c)) {
                        if (procs.length > 0) {
                            procs.forEach(p => {
                                if (p.regulated) {
                                    counts.Regulado.Total++;
                                    if (counts.Regulado[c] !== undefined) counts.Regulado[c]++;
                                } else {
                                    counts.Interno.Total++;
                                    if (counts.Interno[c] !== undefined) counts.Interno[c]++;

                                    // NOVA CONTAGEM DE TIPO
                                    if (p.type === 'Emergência') counts.InternoTypes[c].Emergencia++;
                                    else if (p.type === 'Projetos') counts.InternoTypes[c].Projetos++;
                                    else counts.InternoTypes[c].Emergencia++; // Fallback pra antigos
                                }
                            });
                        } else {
                            counts.Interno.Total++;
                            if (counts.Interno[c] !== undefined) counts.Interno[c]++;

                            // NOVA CONTAGEM DE TIPO
                            const p = (procs.length > 0) ? procs[0] : {};
                            if (p.type === 'Emergência') counts.InternoTypes[c].Emergencia++;
                            else if (p.type === 'Projetos') counts.InternoTypes[c].Projetos++;
                            else counts.InternoTypes[c].Emergencia++;
                        }
                    }
                }
            });
        }
    });

    return { total: totalSlots, occupied: occupiedSlots, counts, totalMarcacoes, totalCirurgia, totalLaser, startDate, endDate, locationCounts };
}

function updateCharts(stats) {
    const ctxLoc = document.getElementById('chart-location');
    const ctxContract = document.getElementById('chart-specialty');

    if (!ctxLoc || !ctxContract) return;

    // --- GRÁFICO 1: DISTRIBUIÇÃO POR UNIDADE FÍSICA (DOUGHNUT) ---
    const locLabels = Object.keys(stats.locationCounts || {});
    const locValues = Object.values(stats.locationCounts || {});
    const locColors = ['#0284c7', '#059669', '#d97706', '#7c3aed', '#db2777', '#475569'];

    if (chartLocInstance) {
        // ATUALIZAÇÃO SUAVE (Evita o gráfico piscar)
        chartLocInstance.data.labels = locLabels;
        chartLocInstance.data.datasets[0].data = locValues;
        chartLocInstance.update();
    } else {
        // CRIAÇÃO COM DESIGN PREMIUM
        chartLocInstance = new Chart(ctxLoc, {
            type: 'doughnut',
            data: {
                labels: locLabels,
                datasets: [{
                    data: locValues,
                    backgroundColor: locColors.slice(0, locLabels.length),
                    borderWidth: 0, // Tira a borda branca padrão agressiva
                    hoverOffset: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { usePointStyle: true, padding: 20, font: { family: "'Inter', sans-serif", size: 12, weight: '500' } }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleFont: { family: "'Inter', sans-serif" },
                        bodyFont: { family: "'Inter', sans-serif" },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                cutout: '72%' // Deixa o anel mais fino e elegante
            }
        });
    }

    // --- GRÁFICO 2: DESEMPENHO POR CONTRATO (STACKED BAR) ---
    const barDataReg = [stats.counts.Regulado.ESTADO, stats.counts.Regulado.SERRA, stats.counts.Regulado.SALGUEIRO];
    const barDataInt = [stats.counts.Interno.ESTADO, stats.counts.Interno.SERRA, stats.counts.Interno.SALGUEIRO];

    if (chartSpecInstance) {
        // ATUALIZAÇÃO SUAVE
        chartSpecInstance.data.datasets[0].data = barDataReg;
        chartSpecInstance.data.datasets[1].data = barDataInt;
        chartSpecInstance.update();
    } else {
        // CRIAÇÃO COM DESIGN PREMIUM
        chartSpecInstance = new Chart(ctxContract, {
            type: 'bar',
            data: {
                labels: ['Estado', 'Serra Talhada', 'Salgueiro'],
                datasets: [
                    {
                        label: 'Regulados',
                        data: barDataReg,
                        backgroundColor: '#7c3aed',
                        borderRadius: 6, // Arredonda o topo das barras
                        maxBarThickness: 35, // Limite máximo de largura em pixels
                        barPercentage: 0.6,  // Ocupa 60% da categoria (torna a barra mais fina)
                        categoryPercentage: 0.5 // Aumenta o espaçamento entre os grupos de barras
                    },
                    {
                        label: 'Internos',
                        data: barDataInt,
                        backgroundColor: '#059669',
                        borderRadius: 6,
                        maxBarThickness: 35,
                        barPercentage: 0.6,
                        categoryPercentage: 0.5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 20, font: { family: "'Inter', sans-serif", weight: '500' } }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        mode: 'index',
                        intersect: false,
                        titleFont: { family: "'Inter', sans-serif" },
                        bodyFont: { family: "'Inter', sans-serif" }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false }, // Limpa as linhas verticais
                        ticks: { font: { family: "'Inter', sans-serif", weight: '600' } }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: { color: '#f1f5f9', drawBorder: false }, // Linhas horizontais sutis
                        ticks: { stepSize: 1, font: { family: "'Inter', sans-serif" } }
                    }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
    }
}

function updateKPIs() {
    const stats = calculateFilteredStats();
    const { total, occupied, counts, totalMarcacoes, totalCirurgia, totalLaser } = stats;

    const totalReg = counts.Regulado.Total;
    const totalInt = counts.Interno.Total;

    const universeGov = totalReg + totalInt;
    const validBaseGov = universeGov > 0 ? universeGov : 1;

    const realIdleCount = total - occupied;

    animateMetric('glb-marcacoes', totalMarcacoes);
    animateMetric('glb-cirurgia', totalCirurgia);
    animateMetric('glb-laser', totalLaser);

    const pctRegGlobal = (totalReg / validBaseGov) * 100;
    animateMetric('kpi-60-val', pctRegGlobal, true);
    document.getElementById('prog-60').style.width = Math.min(pctRegGlobal, 100) + '%';

    animateSubMetric('stat-estado', counts.Regulado.ESTADO, totalReg);
    animateSubMetric('stat-serra', counts.Regulado.SERRA, totalReg);
    animateSubMetric('stat-salgueiro', counts.Regulado.SALGUEIRO, totalReg);

    const pctIntGlobal = (totalInt / validBaseGov) * 100;
    animateMetric('kpi-40-val', pctIntGlobal, true);
    document.getElementById('prog-40').style.width = Math.min(pctIntGlobal, 100) + '%';

    animateSubMetric('stat-int-estado', counts.Interno.ESTADO, totalInt);
    animateSubMetric('stat-int-serra', counts.Interno.SERRA, totalInt);
    animateSubMetric('stat-int-salgueiro', counts.Interno.SALGUEIRO, totalInt);

    animateMetric('stat-recife', counts.Municipal.RECIFE);
    animateMetric('stat-jaboatao', counts.Municipal.JABOATÃO);
    animateMetric('kpi-mun-val', counts.Municipal.Total);

    // --- GERAÇÃO DOS BALÕES DE TOOLTIP (HOVER) NOS INTERNOS ---
    const setTooltip = (id, c) => {
        const el = document.getElementById(id).parentElement;

        // Remove o balão nativo feio e prepara a div para receber o novo
        el.removeAttribute('title');
        el.classList.add('tooltip-container');

        // Cria a caixinha customizada se ela ainda não existir no card
        let tooltip = el.querySelector('.custom-tooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            el.appendChild(tooltip);
        }

        const totalIntContrato = counts.Interno[c];

        if (totalIntContrato > 0) {
            const em = counts.InternoTypes[c].Emergencia;
            const pr = counts.InternoTypes[c].Projetos;
            const emPct = ((em / totalIntContrato) * 100).toFixed(1);
            const prPct = ((pr / totalIntContrato) * 100).toFixed(1);

            // Injeta o HTML bem formatado dentro da caixinha flutuante
            tooltip.innerHTML = `
                <div style="font-weight:800; color:#e0f2fe; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:6px; margin-bottom:8px; text-transform:uppercase; font-size:0.7rem; letter-spacing: 0.5px;">
                    Detalhamento
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:6px; align-items:center;">
                    <span style="color:#f0f9ff; opacity:0.9">Emergência:</span> 
                    <span style="font-weight:700; color:#fff; font-size:0.85rem">${em} <span style="font-size:0.65rem; color:#e0f2fe; font-weight:500">(${emPct}%)</span></span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#f0f9ff; opacity:0.9">Projetos:</span> 
                    <span style="font-weight:700; color:#fff; font-size:0.85rem">${pr} <span style="font-size:0.65rem; color:#e0f2fe; font-weight:500">(${prPct}%)</span></span>
                </div>
            `;
            el.style.cursor = 'help';
            tooltip.style.display = 'block';
        } else {
            // Se não tiver procedimentos internos, não mostra a caixinha
            el.style.cursor = 'default';
            tooltip.style.display = 'none';
        }
    };

    setTooltip('stat-int-estado', 'ESTADO');
    setTooltip('stat-int-serra', 'SERRA');
    setTooltip('stat-int-salgueiro', 'SALGUEIRO');

    // Atualiza Gráficos
    updateCharts(stats);
}

// --- PDF: TAMBÉM AJUSTADO ---
function generateDashboardPDF() {
    const stats = calculateFilteredStats();
    let monthVal = `${stats.startDate} a ${stats.endDate}`;
    const { total, occupied, counts, totalMarcacoes, totalCirurgia, totalLaser } = stats;

    // Cálculos
    const totalMunicipal = counts.Municipal.Total;
    const totalReg = counts.Regulado.Total;
    const totalInt = counts.Interno.Total;
    const universeGov = totalReg + totalInt;
    const validBase = universeGov > 0 ? universeGov : 1;

    const realIdleCount = total - occupied;
    const pctOccupied = total > 0 ? (occupied / total * 100).toFixed(1) : "0.0";

    const pctRegGlobal = (totalReg / validBase * 100).toFixed(1);
    const pctIntGlobal = (totalInt / validBase * 100).toFixed(1);

    const calcSubPct = (val, groupTot) => groupTot > 0 ? (val / groupTot * 100).toFixed(1) : "0.0";

    const regEstadoPct = calcSubPct(counts.Regulado.ESTADO, totalReg);
    const regSerraPct = calcSubPct(counts.Regulado.SERRA, totalReg);
    const regSalgPct = calcSubPct(counts.Regulado.SALGUEIRO, totalReg);

    const intEstadoPct = calcSubPct(counts.Interno.ESTADO, totalInt);
    const intSerraPct = calcSubPct(counts.Interno.SERRA, totalInt);
    const intSalgPct = calcSubPct(counts.Interno.SALGUEIRO, totalInt);

    const content = document.createElement('div');
    content.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
            <div style="border-bottom: 2px solid #0284c7; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="color: #1e293b; font-size: 24px; margin: 0;">Relatório de Governança Cirúrgica</h1>
                <div style="color: #64748b; font-size: 14px; margin-top: 5px;">Período de Referência: ${monthVal}</div>
                <div style="color: #dc2626; font-size: 11px; margin-top: 2px;">*Metas calculadas sobre total de PROCEDIMENTOS (não vagas)</div>
            </div>

            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-top:0; color:#475569; font-size:16px; border-bottom:1px solid #cbd5e1; padding-bottom:5px;">Visão Geral</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;"><strong>Capacidade Física (Vagas):</strong> ${total}</td>
                         <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;"><strong>Vagas Livres:</strong> ${realIdleCount}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;"><strong>Taxa Ocupação Física:</strong> ${pctOccupied}%</td>
                        <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;"><strong>Total Procedimentos Gov:</strong> ${universeGov}</td>
                    </tr>
                </table>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <h3 style="color:#7c3aed; font-size:16px; border-bottom:1px solid #ddd; padding-bottom:5px;">Procedimentos Regulados (Meta 60%)</h3>
                    <div style="font-size:24px; font-weight:bold; color:#7c3aed; margin-bottom:10px;">${pctRegGlobal}% <span style="font-size:12px; color:#666">dos procs</span></div>
                    <table style="width: 100%; border: 1px solid #e2e8f0; font-size:13px;">
                        <tr style="background:#f1f5f9;"><th style="padding:8px; text-align:left;">Unidade</th><th style="padding:8px; text-align:right;">% Grupo (Qtd)</th></tr>
                        <tr><td style="padding:8px; border-bottom:1px solid #eee;">Estado</td><td style="padding:8px; text-align:right;">${regEstadoPct}% (${counts.Regulado.ESTADO})</td></tr>
                        <tr><td style="padding:8px; border-bottom:1px solid #eee;">Serra Talhada</td><td style="padding:8px; text-align:right;">${regSerraPct}% (${counts.Regulado.SERRA})</td></tr>
                        <tr><td style="padding:8px;">Salgueiro</td><td style="padding:8px; text-align:right;">${regSalgPct}% (${counts.Regulado.SALGUEIRO})</td></tr>
                        <tr style="background:#f8fafc; font-weight:bold;"><td style="padding:8px;">TOTAL</td><td style="padding:8px; text-align:right;">100% (${totalReg})</td></tr>
                    </table>
                </div>

                <div style="flex:1;">
                    <h3 style="color:#059669; font-size:16px; border-bottom:1px solid #ddd; padding-bottom:5px;">Procedimentos Internos (Meta 40%)</h3>
                    <div style="font-size:24px; font-weight:bold; color:#059669; margin-bottom:10px;">${pctIntGlobal}% <span style="font-size:12px; color:#666">dos procs</span></div>
                    <table style="width: 100%; border: 1px solid #e2e8f0; font-size:13px;">
                        <tr style="background:#f1f5f9;"><th style="padding:8px; text-align:left;">Unidade</th><th style="padding:8px; text-align:right;">% Grupo (Qtd)</th></tr>
                        <tr><td style="padding:8px; border-bottom:1px solid #eee;">Estado</td><td style="padding:8px; text-align:right;">${intEstadoPct}% (${counts.Interno.ESTADO})</td></tr>
                        <tr><td style="padding:8px; border-bottom:1px solid #eee;">Serra Talhada</td><td style="padding:8px; text-align:right;">${intSerraPct}% (${counts.Interno.SERRA})</td></tr>
                        <tr><td style="padding:8px;">Salgueiro</td><td style="padding:8px; text-align:right;">${intSalgPct}% (${counts.Interno.SALGUEIRO})</td></tr>
                        <tr style="background:#f8fafc; font-weight:bold;"><td style="padding:8px;">TOTAL</td><td style="padding:8px; text-align:right;">100% (${totalInt})</td></tr>
                    </table>
                </div>
            </div>

            <div style="margin-top: 30px;">
                 <h3 style="color:#64748b; font-size:16px; border-bottom:1px solid #ddd; padding-bottom:5px;">Municípios (Procedimentos Realizados)</h3>
                 <table style="width: 100%; border: 1px solid #e2e8f0; font-size:13px;">
                    <tr style="background:#f1f5f9;"><th style="padding:8px; text-align:left;">Município</th><th style="padding:8px; text-align:right;">Qtd</th></tr>
                    <tr><td style="padding:8px; border-bottom:1px solid #eee;">Recife</td><td style="padding:8px; text-align:right;">${counts.Municipal.RECIFE}</td></tr>
                    <tr><td style="padding:8px;">Jaboatão</td><td style="padding:8px; text-align:right;">${counts.Municipal.JABOATÃO}</td></tr>
                 </table>
            </div>

            <div style="margin-top:40px; font-size:10px; color:#94a3b8; text-align:center; border-top:1px solid #eee; padding-top:10px;">
                Documento gerado automaticamente pelo sistema GovCirúrgica em ${new Date().toLocaleString()}
            </div>
        </div>
    `;

    const opt = {
        margin: 10,
        filename: `Relatorio_Gov_${monthVal}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    setLoading(true);

    if (typeof html2pdf === 'undefined') {
        setLoading(false);
        return showToast('Erro: Biblioteca PDF não carregada.', 'error');
    }

    html2pdf().set(opt).from(content).save().then(() => {
        setLoading(false);
        showToast('PDF baixado com sucesso!', 'success');
    }).catch(err => {
        setLoading(false);
        console.error(err);
        showToast('Erro ao gerar PDF.', 'error');
    });
}

// --- MODAIS GERAIS ---

let messageCallback = null;

function showMessageModal(title, message, type = 'success', onConfirm = null) {
    const modal = document.getElementById('message-modal');
    const iconEl = document.getElementById('msg-icon');
    const btns = document.getElementById('msg-actions');

    document.getElementById('msg-title').innerText = title;
    document.getElementById('msg-body').innerHTML = message;
    messageCallback = onConfirm;

    btns.style.display = 'flex';
    if (type === 'loading') btns.style.display = 'none';

    const icons = {
        'success': { color: '#16a34a', bg: '#dcfce7', svg: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>` },
        'warning': { color: '#d97706', bg: '#fef3c7', svg: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>` },
        'error': { color: '#dc2626', bg: '#fee2e2', svg: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>` },
        'confirm': { color: '#0284c7', bg: '#e0f2fe', svg: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>` },
        'loading': { color: '#0284c7', bg: '#f0f9ff', svg: `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>` }
    };

    const style = icons[type] || icons['success'];
    iconEl.style.color = style.color;
    iconEl.style.background = style.bg;
    iconEl.innerHTML = style.svg;

    const btnConfirm = document.getElementById('msg-btn-confirm');
    const btnCancel = document.getElementById('msg-btn-cancel');

    if (type === 'confirm') {
        btnCancel.style.display = 'block';
        btnConfirm.innerText = 'Confirmar';
        btnConfirm.onclick = () => { if (messageCallback) messageCallback(); };
    } else {
        btnCancel.style.display = 'none';
        btnConfirm.innerText = 'OK';
        btnConfirm.onclick = () => closeMessageModal();
    }

    modal.classList.add('open');
}

function closeMessageModal() {
    document.getElementById('message-modal').classList.remove('open');
    messageCallback = null;
}

function exportDailyReport() {
    const startInput = document.getElementById('dash-date-start');
    const endInput = document.getElementById('dash-date-end');

    let startDate = startInput && startInput.value ? startInput.value : selectedDateKey;
    let endDate = endInput && endInput.value ? endInput.value : startDate;
    if (startDate > endDate && endDate) endDate = startDate;

    const locFilter = document.getElementById('location-filter').value;
    const roomFilter = document.getElementById('room-filter').value;
    const specFilter = document.getElementById('specialty-filter') ? document.getElementById('specialty-filter').value : 'ALL';

    let slots = [];
    Object.keys(appointments).forEach(dateKey => {
        if (dateKey >= startDate && dateKey <= endDate) {
            slots = slots.concat(appointments[dateKey]);
        }
    });

    if (slots.length === 0) return showToast('Nada para exportar no período.', 'warning');

    slots = slots.filter(s => {
        if (locFilter !== 'ALL' && s.location !== locFilter) return false;
        if (roomFilter !== 'ALL' && String(s.room) !== roomFilter) return false;
        if (specFilter !== 'ALL' && s.specialty !== specFilter) return false;
        return true;
    });

    if (slots.length === 0) return showToast('Nenhuma vaga correspondente aos filtros.', 'warning');

    const headers = ["Data", "Hora", "Unidade", "Sala", "Tipo", "Status", "Paciente", "Prontuario", "Contrato", "Regulado", "Medico", "Procedimento"];
    const rows = slots.map(s => {
        let procFormatted = s.procedure;
        try {
            if (s.procedure && (s.procedure.startsWith('[') || s.procedure.startsWith('{'))) {
                const parsed = JSON.parse(s.procedure);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    procFormatted = `${parsed[0].name} (${parsed[0].regulated ? 'Reg' : 'Int'})`;
                }
            }
        } catch (e) { console.warn("Erro formatação", e); }

        return [
            s.date || "?", s.time, s.location, s.room, s.specialty || '', s.status, s.patient, s.record, s.contract,
            (s.regulated ? 'SIM' : 'NÃO'), s.doctor, procFormatted
        ].map(val => `"${String(val || '').replace(/"/g, '""')}"`).join(';');
    });

    const csvContent = "\uFEFF" + [headers.join(';'), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `Relatorio_${startDate === endDate ? startDate : startDate + '_a_' + endDate}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

window.onclick = function (event) {
    if (event.target === document.getElementById('login-modal')) closeLoginModal();
    if (event.target === document.getElementById('booking-modal')) closeModal();
    if (event.target === document.getElementById('message-modal')) closeMessageModal();
}

// Inicia
initData();
</script>
</body>

</html>